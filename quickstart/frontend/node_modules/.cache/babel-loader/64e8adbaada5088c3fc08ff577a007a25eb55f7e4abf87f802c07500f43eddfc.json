{"ast":null,"code":"import _objectSpread from\"/root/cn-quickstart/quickstart/frontend/node_modules/@babel/runtime/helpers/esm/objectSpread2.js\";import React,{useState,useEffect,useMemo,useCallback,useRef}from'react';import{useLocation,useNavigate}from'react-router-dom';import{useAppStore}from'../stores';import{backendApi}from'../services/backendApi';import toast from'react-hot-toast';import{useWalletAuth,walletManager}from'../wallet';import{useLoopBalances,useUtxoBalances}from'../hooks';import TokenSelector from'./TokenSelector';import{submitTx}from'../loop/submitTx';import{getLoopProvider}from'../loop/loopProvider';import{balancesKeyFromMap,lpKeyFromPositions,poolKeyFromPools,refreshLedgerState}from'../utils/refreshLedgerState';import{jsx as _jsx,jsxs as _jsxs,Fragment as _Fragment}from\"react/jsx-runtime\";const OPERATOR_PARTY=process.env.REACT_APP_OPERATOR_PARTY||process.env.REACT_APP_OPERATOR_PARTY_ID||'ClearportX-DEX-1::122081f2b8e29cbe57d1037a18e6f70e57530773b3a4d1bea6bab981b7a76e943b37';const LiquidityInterface=()=>{var _liquidityResult$cons,_liquidityResult$cons2,_liquidityResult$cons3,_liquidityResult$cons4,_liquidityResult$cons5;const location=useLocation();const navigate=useNavigate();const{pools,setPools}=useAppStore();const{partyId,walletType}=useWalletAuth();const partyForBackend=walletType==='loop'?null:partyId||null;const[mode,setMode]=useState('add');const[tokens,setTokens]=useState([]);const[lpTokens,setLpTokens]=useState([]);const[lpPositions,setLpPositions]=useState([]);const[selectedTokenA,setSelectedTokenA]=useState(null);const[selectedTokenB,setSelectedTokenB]=useState(null);const[showTokenASelector,setShowTokenASelector]=useState(false);const[showTokenBSelector,setShowTokenBSelector]=useState(false);const[amountA,setAmountA]=useState('');const[amountB,setAmountB]=useState('');const[loading,setLoading]=useState(false);const[isSubmittingLiquidity,setIsSubmittingLiquidity]=useState(false);const[calculating,setCalculating]=useState(false);const[liquidityResult,setLiquidityResult]=useState(null);const[liquidityStatus,setLiquidityStatus]=useState(null);const[ledgerRefreshStatus,setLedgerRefreshStatus]=useState(null);const[rawPools,setRawPools]=useState([]);const loopRequestStateRef=useRef({lastCallAt:0});const balancesSnapshotRef=useRef('');const poolSnapshotRef=useRef('');const lpSnapshotRef=useRef('');const{balances:loopBalances,reload:reloadLoopBalances,isRefreshing:loopRefreshing}=useLoopBalances(partyId||null,walletType,{refreshIntervalMs:15000,paused:walletType==='loop'&&isSubmittingLiquidity});const{balances:utxoBalances,reload:reloadUtxoBalances,isRefreshing:utxoRefreshing}=useUtxoBalances(partyForBackend,{ownerOnly:true,refreshIntervalMs:15000});const LP_BASELINES_STORAGE_KEY='clearportx:lp-baselines:v1';const[lpBaselines,setLpBaselines]=useState(()=>{if(typeof window==='undefined'){return{};}try{const stored=window.localStorage.getItem(LP_BASELINES_STORAGE_KEY);return stored?JSON.parse(stored):{};}catch(_unused){return{};}});const lpBaselinesRef=useRef(lpBaselines);useEffect(()=>{lpBaselinesRef.current=lpBaselines;},[lpBaselines]);const baselinesInitializedRef=useRef(Object.keys(lpBaselinesRef.current).length>0);const persistLpBaselines=useCallback(next=>{if(typeof window!=='undefined'){window.localStorage.setItem(LP_BASELINES_STORAGE_KEY,JSON.stringify(next));}},[]);const computePoolTotals=useCallback(positions=>{const totals=new Map();positions.forEach(pos=>{var _totals$get;if(!pos.poolId){return;}totals.set(pos.poolId,((_totals$get=totals.get(pos.poolId))!==null&&_totals$get!==void 0?_totals$get:0)+(pos.amount||0));});return totals;},[]);const seedBaselinesIfNeeded=useCallback((party,positions)=>{if(baselinesInitializedRef.current){return lpBaselinesRef.current;}const totals=computePoolTotals(positions);const snapshot=_objectSpread({},lpBaselinesRef.current);let changed=false;totals.forEach((sum,poolId)=>{const key=\"\".concat(party,\"::\").concat(poolId);if(snapshot[key]===undefined){snapshot[key]=sum;changed=true;}});if(changed){persistLpBaselines(snapshot);lpBaselinesRef.current=snapshot;setLpBaselines(snapshot);}baselinesInitializedRef.current=true;return snapshot;},[computePoolTotals,persistLpBaselines]);const augmentPoolsWithUserLiquidity=useCallback((poolList,lpPositions,baselineMap,actingParty)=>{return poolList.map(pool=>{var _baselineMap$baseline;const normalizedPoolId=pool.poolId||pool.contractId;const poolPositions=lpPositions.filter(position=>position.poolId===normalizedPoolId);const totalHeld=poolPositions.reduce((sum,position)=>sum+(position.amount||0),0);const baselineKey=\"\".concat(actingParty,\"::\").concat(normalizedPoolId);const baseline=(_baselineMap$baseline=baselineMap[baselineKey])!==null&&_baselineMap$baseline!==void 0?_baselineMap$baseline:0;const userLiquidity=Math.max(0,totalHeld-baseline);const userShare=userLiquidity>0&&pool.totalLiquidity>0?userLiquidity/pool.totalLiquidity*100:0;return _objectSpread(_objectSpread({},pool),{},{poolId:normalizedPoolId,userLiquidity,userShare});});},[]);const handleResetLiquidityView=useCallback(()=>{if(!partyId){toast.error('Connect a wallet to resync liquidity view');return;}const totals=computePoolTotals(lpTokens);const snapshot=_objectSpread({},lpBaselinesRef.current);let changed=false;totals.forEach((sum,poolId)=>{const key=\"\".concat(partyId,\"::\").concat(poolId);if(snapshot[key]!==sum){snapshot[key]=sum;changed=true;}});if(changed){persistLpBaselines(snapshot);lpBaselinesRef.current=snapshot;setLpBaselines(snapshot);toast.success('Liquidity view resynced with ledger balances');}else{toast.success('Liquidity view already matches ledger balances');}},[partyId,computePoolTotals,lpTokens,persistLpBaselines]);const renderTokenBadge=function(token,fallbackColor){var _token$symbol$charAt,_token$symbol;let fallbackTextColor=arguments.length>2&&arguments[2]!==undefined?arguments[2]:'text-gray-900 dark:text-gray-100';return/*#__PURE__*/_jsx(\"div\",{className:\"w-8 h-8 rounded-full overflow-hidden border border-white/40 shadow-inner flex items-center justify-center \".concat(token!==null&&token!==void 0&&token.logoUrl?'bg-white dark:bg-dark-700':fallbackColor),children:token!==null&&token!==void 0&&token.logoUrl?/*#__PURE__*/_jsx(\"img\",{src:token.logoUrl,alt:\"\".concat(token.symbol,\" logo\"),className:\"w-full h-full object-cover\",loading:\"lazy\"}):/*#__PURE__*/_jsx(\"span\",{className:\"text-xs font-bold uppercase \".concat(fallbackTextColor),children:(_token$symbol$charAt=token===null||token===void 0?void 0:(_token$symbol=token.symbol)===null||_token$symbol===void 0?void 0:_token$symbol.charAt(0))!==null&&_token$symbol$charAt!==void 0?_token$symbol$charAt:'?'})});};const instrumentIdToSymbol=instrumentId=>{const raw=instrumentId||'';const upper=raw.toUpperCase();if(upper==='AMULET')return'CC';return upper;};const decimalAddStrings=(a,b)=>{const sa=a!==null&&a!==void 0?a:'0';const sb=b!==null&&b!==void 0?b:'0';const[ia,fa='']=sa.split('.');const[ib,fb='']=sb.split('.');const fracLen=Math.max(fa.length,fb.length);const normFa=(fa+'0'.repeat(fracLen)).slice(0,fracLen);const normFb=(fb+'0'.repeat(fracLen)).slice(0,fracLen);const intA=BigInt(ia||'0');const intB=BigInt(ib||'0');const fracA=BigInt(normFa||'0');const fracB=BigInt(normFb||'0');const fracSum=fracA+fracB;const baseStr='1'+'0'.repeat(fracLen||0);const base=BigInt(baseStr);const carry=fracSum/base;const fracRes=fracSum%base;const intRes=intA+intB+carry;const fracStr=fracLen>0?fracRes.toString().padStart(fracLen,'0').replace(/0+$/,''):'';return fracStr.length>0?\"\".concat(intRes.toString(),\".\").concat(fracStr):intRes.toString();};const tokenBOptions=useMemo(()=>tokens.filter(token=>token.symbol!==(selectedTokenA===null||selectedTokenA===void 0?void 0:selectedTokenA.symbol)),[tokens,selectedTokenA]);const balancesBySymbol=useMemo(()=>{if(walletType==='loop'){const map={};Object.entries(loopBalances).forEach(_ref=>{let[symbol,entry]=_ref;map[symbol.toUpperCase()]={amount:entry.amount,decimals:entry.decimals};});return map;}const map={};Object.values(utxoBalances).forEach(entry=>{var _existing$decimals;const symbol=instrumentIdToSymbol(entry.instrumentId);const existing=map[symbol];map[symbol]={amount:existing?decimalAddStrings(existing.amount,entry.amount):entry.amount,decimals:(_existing$decimals=existing===null||existing===void 0?void 0:existing.decimals)!==null&&_existing$decimals!==void 0?_existing$decimals:entry.decimals};});return map;},[walletType,loopBalances,utxoBalances]);const balancesRefreshing=walletType==='loop'?loopRefreshing:utxoRefreshing;useEffect(()=>{balancesSnapshotRef.current=balancesKeyFromMap(balancesBySymbol);},[balancesBySymbol]);const poolSnapshotKey=useMemo(()=>{if(!rawPools.length||!selectedTokenA||!selectedTokenB){return'';}const match=rawPools.find(p=>p.tokenA.symbol===selectedTokenA.symbol&&p.tokenB.symbol===selectedTokenB.symbol||p.tokenA.symbol===selectedTokenB.symbol&&p.tokenB.symbol===selectedTokenA.symbol);if(!match){return'';}return poolKeyFromPools(rawPools,match.contractId||match.poolId);},[rawPools,selectedTokenA,selectedTokenB]);useEffect(()=>{poolSnapshotRef.current=poolSnapshotKey;},[poolSnapshotKey]);useEffect(()=>{lpSnapshotRef.current=lpKeyFromPositions(lpPositions);},[lpPositions]);const getBalanceEntry=useCallback(symbol=>{if(!symbol){return undefined;}return balancesBySymbol[symbol.toUpperCase()];},[balancesBySymbol]);const formatBalanceDisplay=useCallback(symbol=>{const entry=getBalanceEntry(symbol);if(!entry){return'0.0000';}const numeric=Number(entry.amount);if(!Number.isFinite(numeric)){return entry.amount;}return numeric.toLocaleString('en-US',{maximumFractionDigits:4});},[getBalanceEntry]);const formatLpBalance=useCallback(raw=>{if(!raw)return'0';const numeric=Number(raw);if(!Number.isFinite(numeric)){return raw;}return numeric.toLocaleString('en-US',{maximumFractionDigits:6});},[]);const formatShareBps=useCallback(bps=>{if(bps===undefined||bps===null||Number.isNaN(bps)){return'—';}return\"\".concat((bps/100).toFixed(2),\"%\");},[]);const resolvePoolLabel=useCallback(poolCid=>{if(!poolCid)return'Unknown pool';const match=rawPools.find(p=>p.contractId===poolCid||p.poolId===poolCid);if(!match){return poolCid;}return\"\".concat(match.tokenA.symbol,\"/\").concat(match.tokenB.symbol);},[rawPools]);const reloadBalances=useCallback(async()=>{if(walletType==='loop'){await reloadLoopBalances();return;}await reloadUtxoBalances();},[walletType,reloadLoopBalances,reloadUtxoBalances]);const refreshLedger=useCallback(async(label,poolCid)=>{if(!partyId)return;await refreshLedgerState({label,getSnapshot:()=>({balancesKey:balancesSnapshotRef.current,poolKey:poolSnapshotRef.current,lpKey:lpSnapshotRef.current}),fetchSnapshot:async()=>{await reloadBalances();const latestPools=await backendApi.getPools();setRawPools(latestPools);const latestPositions=await backendApi.getLpPositions(partyId,poolCid||undefined);setLpPositions(latestPositions);console.log('[lpPositions] loaded',{count:latestPositions.length,first:latestPositions[0]});return{balancesKey:balancesSnapshotRef.current,poolKey:poolKeyFromPools(latestPools,poolCid!==null&&poolCid!==void 0?poolCid:undefined),lpKey:lpKeyFromPositions(latestPositions,poolCid!==null&&poolCid!==void 0?poolCid:undefined)};},onStatus:setLedgerRefreshStatus});},[partyId,reloadBalances]);const waitForLoopCooldown=useCallback(async function(label){let minGapMs=arguments.length>1&&arguments[1]!==undefined?arguments[1]:LOOP_MIN_GAP_MS;const now=Date.now();const elapsed=now-loopRequestStateRef.current.lastCallAt;if(elapsed<minGapMs){const delayMs=minGapMs-elapsed;setLiquidityStatus(\"Waiting \".concat(Math.ceil(delayMs/1000),\"s to avoid Loop rate limits (\").concat(label,\")\"));await sleep(delayMs);}loopRequestStateRef.current.lastCallAt=Date.now();},[]);useEffect(()=>{reloadBalances();},[reloadBalances,partyId,walletType]);useEffect(()=>{if(!partyId){setLpPositions([]);return;}backendApi.getLpPositions(partyId).then(positions=>{setLpPositions(positions);console.log('[lpPositions] loaded',{count:positions.length,first:positions[0]});}).catch(error=>{console.warn('[lpPositions] load failed',error);});},[partyId]);// Charger les tokens depuis les pools actifs + balances utilisateur\nuseEffect(()=>{const loadTokens=async()=>{try{var _location$state;const poolsData=await backendApi.getPools();const uniqueTokensMap=new Map();poolsData.forEach(pool=>{if(!uniqueTokensMap.has(pool.tokenA.symbol)){uniqueTokensMap.set(pool.tokenA.symbol,_objectSpread(_objectSpread({},pool.tokenA),{},{balance:0}));}if(!uniqueTokensMap.has(pool.tokenB.symbol)){uniqueTokensMap.set(pool.tokenB.symbol,_objectSpread(_objectSpread({},pool.tokenB),{},{balance:0}));}});let tokensWithBalances=Array.from(uniqueTokensMap.values()).map(token=>_objectSpread(_objectSpread({},token),{},{balance:0}));let userLpTokens=[];if(partyId){try{const[userTokens,lpPositions,lpLedgerPositions]=await Promise.all([backendApi.getWalletTokens(partyId),backendApi.getLpTokens(partyId),backendApi.getLpPositions(partyId)]);userLpTokens=lpPositions;setLpPositions(lpLedgerPositions);console.log('[lpPositions] loaded',{count:lpLedgerPositions.length,first:lpLedgerPositions[0]});tokensWithBalances=tokensWithBalances.map(token=>{const userToken=userTokens.find(t=>t.symbol===token.symbol);return _objectSpread(_objectSpread({},token),{},{balance:(userToken===null||userToken===void 0?void 0:userToken.balance)||0});});}catch(walletError){console.warn('Failed to load wallet state for party',walletError);}}setTokens(tokensWithBalances);setLpTokens(userLpTokens);setRawPools(poolsData);setSelectedTokenA(prev=>prev?tokensWithBalances.find(t=>t.symbol===prev.symbol)||prev:null);setSelectedTokenB(prev=>prev?tokensWithBalances.find(t=>t.symbol===prev.symbol)||prev:null);if(partyId){const baselineSnapshot=seedBaselinesIfNeeded(partyId,userLpTokens);const enhancedPools=augmentPoolsWithUserLiquidity(poolsData,userLpTokens,baselineSnapshot,partyId);setPools(enhancedPools);}else{setPools(poolsData.map(pool=>_objectSpread(_objectSpread({},pool),{},{userLiquidity:0,userShare:0})));}const pool=(_location$state=location.state)===null||_location$state===void 0?void 0:_location$state.pool;if(pool){const presetA=tokensWithBalances.find(t=>t.symbol===pool.tokenA.symbol)||_objectSpread(_objectSpread({},pool.tokenA),{},{balance:0});const presetB=tokensWithBalances.find(t=>t.symbol===pool.tokenB.symbol)||_objectSpread(_objectSpread({},pool.tokenB),{},{balance:0});setSelectedTokenA(presetA);setSelectedTokenB(presetB);}console.log('✅ Loaded tokens from pools for liquidity:',tokensWithBalances);}catch(error){console.error('Error loading tokens:',error);toast.error('Failed to load tokens');}};loadTokens();},[partyId,location.state,setPools,augmentPoolsWithUserLiquidity,seedBaselinesIfNeeded]);const refreshWalletState=useCallback(async()=>{if(!partyId){return{walletTokens:[],lpPositions:[],lpLedgerPositions:[]};}try{const[walletTokens,lpPositions,lpLedgerPositions]=await Promise.all([backendApi.getWalletTokens(partyId),backendApi.getLpTokens(partyId),backendApi.getLpPositions(partyId)]);setTokens(currentTokens=>{const updated=currentTokens.map(token=>{const match=walletTokens.find(t=>t.symbol===token.symbol);return _objectSpread(_objectSpread({},token),{},{balance:(match===null||match===void 0?void 0:match.balance)||0});});setSelectedTokenA(prev=>prev?updated.find(t=>t.symbol===prev.symbol)||prev:null);setSelectedTokenB(prev=>prev?updated.find(t=>t.symbol===prev.symbol)||prev:null);return updated;});setLpTokens(lpPositions);setLpPositions(lpLedgerPositions);console.log('[lpPositions] loaded',{count:lpLedgerPositions.length,first:lpLedgerPositions[0]});return{walletTokens,lpPositions,lpLedgerPositions};}catch(error){console.error('Failed to refresh wallet balances:',error);return{walletTokens:[],lpPositions:[],lpLedgerPositions:[]};}},[partyId]);useEffect(()=>{if(!rawPools.length){return;}if(!partyId){setPools(rawPools.map(pool=>_objectSpread(_objectSpread({},pool),{},{userLiquidity:0,userShare:0})));return;}const baselineSnapshot=lpBaselinesRef.current;const enhancedPools=augmentPoolsWithUserLiquidity(rawPools,lpTokens,baselineSnapshot,partyId);setPools(enhancedPools);},[rawPools,lpTokens,lpBaselines,augmentPoolsWithUserLiquidity,setPools,partyId]);// Calculer automatiquement le montant B en fonction du ratio du pool\nuseEffect(()=>{if(!selectedTokenA||!selectedTokenB||!amountA||mode!=='add')return;const calculateAmountB=()=>{setCalculating(true);// Trouver le pool correspondant\nconst pool=pools.find(p=>p.tokenA.symbol===selectedTokenA.symbol&&p.tokenB.symbol===selectedTokenB.symbol||p.tokenA.symbol===selectedTokenB.symbol&&p.tokenB.symbol===selectedTokenA.symbol);if(pool){const isTokenAFirst=pool.tokenA.symbol===selectedTokenA.symbol;const ratio=isTokenAFirst?pool.reserveB/pool.reserveA:pool.reserveA/pool.reserveB;const calculatedAmountB=parseFloat(amountA)*ratio;setAmountB(calculatedAmountB.toFixed(6));}else{// Nouveau pool - ratio 1:1 par défaut\nsetAmountB(amountA);}setCalculating(false);};const timeout=setTimeout(calculateAmountB,300);return()=>clearTimeout(timeout);},[amountA,selectedTokenA,selectedTokenB,pools,mode]);const handleAddLiquidity=async()=>{if(!selectedTokenA||!selectedTokenB||!amountA||!amountB){toast.error('Please fill in all fields');return;}if(!partyId){toast.error('Connect a wallet to add liquidity');return;}const amountANum=parseFloat(amountA);const amountBNum=parseFloat(amountB);if(isNaN(amountANum)||isNaN(amountBNum)||amountANum<=0||amountBNum<=0){toast.error('Please enter valid amounts');return;}try{setLoading(true);setLiquidityResult(null);setLiquidityStatus(null);const pool=pools.find(p=>p.tokenA.symbol===selectedTokenA.symbol&&p.tokenB.symbol===selectedTokenB.symbol||p.tokenA.symbol===selectedTokenB.symbol&&p.tokenB.symbol===selectedTokenA.symbol);if(!pool){toast.error('Pool not found for this token pair');return;}const targetPoolId=pool.poolId||pool.contractId;if(!targetPoolId){toast.error('Pool identifier missing; refresh pools and try again.');return;}const poolCid=pool.contractId&&(pool.poolId===pool.contractId||pool.contractId.startsWith('00'))?pool.contractId:await backendApi.resolvePoolCid(targetPoolId);if(!poolCid){toast.error('Unable to resolve pool CID. Refresh pools and try again.');return;}if(walletType!=='loop'){const response=await backendApi.addLiquidityByCid({poolCid,poolId:targetPoolId,amountA:amountANum.toFixed(10),amountB:amountBNum.toFixed(10),minLPTokens:'0.0000000001'});const toastAmount=(()=>{const raw=typeof(response===null||response===void 0?void 0:response.lpAmount)==='string'?response.lpAmount.trim():'';if(raw){const numeric=Number(raw);if(Number.isFinite(numeric)&&numeric>0){if(numeric>=1){return numeric.toLocaleString('en-US',{maximumFractionDigits:4});}return numeric.toPrecision(4);}return raw;}return estimatedLPTokens.toFixed(4);})();toast.success(\"Liquidity added! LP tokens: \".concat(toastAmount));await refreshLedger('liquidity',poolCid);}else{var _transferA$value,_transferB$value;setIsSubmittingLiquidity(true);const connector=walletManager.getOrCreateLoopConnector();const status=await connector.ensureConnected(\"liquidity-\".concat(Date.now()));if(!status.connected||!getLoopProvider()){const message=status.error||'Loop not connected';setLiquidityResult({ok:false,error:{code:'CONNECT',message}});toast.error(message);return;}const holdingPool=await backendApi.getHoldingPool(poolCid);const poolInstrumentA=holdingPool===null||holdingPool===void 0?void 0:holdingPool.instrumentA;const poolInstrumentB=holdingPool===null||holdingPool===void 0?void 0:holdingPool.instrumentB;if(!(poolInstrumentA!==null&&poolInstrumentA!==void 0&&poolInstrumentA.admin)||!(poolInstrumentA!==null&&poolInstrumentA!==void 0&&poolInstrumentA.id)||!(poolInstrumentB!==null&&poolInstrumentB!==void 0&&poolInstrumentB.admin)||!(poolInstrumentB!==null&&poolInstrumentB!==void 0&&poolInstrumentB.id)){toast.error('Pool instruments missing. Refresh pools and try again.');return;}const instrumentA={instrumentAdmin:poolInstrumentA.admin,instrumentId:poolInstrumentA.id};const instrumentB={instrumentAdmin:poolInstrumentB.admin,instrumentId:poolInstrumentB.id};const poolSymbolA=pool.tokenA.symbol;const isSelectedAForPoolA=selectedTokenA.symbol===poolSymbolA;const amountForA=isSelectedAForPoolA?amountANum:amountBNum;const amountForB=isSelectedAForPoolA?amountBNum:amountANum;const requestId=\"liq-\".concat(Date.now(),\"-\").concat(Math.random().toString(36).slice(2,8));const deadline=new Date(Date.now()+2*60*60*1000).toISOString();const amountForAStr=amountForA.toFixed(10);const amountForBStr=amountForB.toFixed(10);const baseMemo={v:1,kind:'addLiquidity',requestId,poolCid,receiverParty:OPERATOR_PARTY,deadline};const memoA=JSON.stringify(_objectSpread(_objectSpread({},baseMemo),{},{leg:'A',instrumentAdmin:instrumentA.instrumentAdmin,instrumentId:instrumentA.instrumentId,amount:amountForAStr}));const memoB=JSON.stringify(_objectSpread(_objectSpread({},baseMemo),{},{leg:'B',instrumentAdmin:instrumentB.instrumentAdmin,instrumentId:instrumentB.instrumentId,amount:amountForBStr}));setLiquidityStatus('Submitting inbound transfer A');const preparedA=await withLoopRateLimitRetry('Transfer A preparation',()=>prepareLoopTransfer(getLoopProvider(),{recipient:OPERATOR_PARTY,amount:amountForAStr,instrument:instrumentA,memo:memoA,requestedAt:new Date().toISOString(),executeBefore:deadline}),{onRetry:delayMs=>setLiquidityStatus(\"Transfer A preparation rate limited. Retrying in \".concat(Math.ceil(delayMs/1000),\"s\")),beforeAttempt:()=>waitForLoopCooldown('prepare A')});const commandsA=extractPreparedCommands(preparedA);if(commandsA.length===0){setLiquidityResult({ok:false,error:{code:'PREPARE_A',message:'Transfer preparation returned no commands',details:preparedA}});toast.error('Transfer A preparation failed');return;}console.log('[addLiquidity] submitting TI',{leg:'A',instrumentAdmin:instrumentA.instrumentAdmin,instrumentId:instrumentA.instrumentId,amount:amountForAStr,requestId});const transferA=await submitTxWithRateLimitRetry({commands:commandsA,actAs:extractPreparedActAs(preparedA,partyId),readAs:extractPreparedReadAs(preparedA,partyId),deduplicationKey:\"\".concat(requestId,\"-a\"),memo:memoA,mode:'LEGACY',disclosedContracts:extractPreparedDisclosedContracts(preparedA),packageIdSelectionPreference:extractPreparedPackagePreference(preparedA),synchronizerId:extractPreparedSynchronizerId(preparedA)},'Transfer A submission',{onRetry:delayMs=>setLiquidityStatus(\"Transfer A submission rate limited. Retrying in \".concat(Math.ceil(delayMs/1000),\"s\")),beforeAttempt:()=>waitForLoopCooldown('submit A')});if(!transferA.ok||((_transferA$value=transferA.value)===null||_transferA$value===void 0?void 0:_transferA$value.txStatus)!=='SUCCEEDED'){setLiquidityResult({transferA,transferB:null,consume:null});toast.error('Inbound transfer A failed');return;}setLiquidityStatus('Inbound transfer A submitted. Preparing transfer B');setLiquidityStatus('Submitting inbound transfer B');const preparedB=await withLoopRateLimitRetry('Transfer B preparation',()=>prepareLoopTransfer(getLoopProvider(),{recipient:OPERATOR_PARTY,amount:amountForBStr,instrument:instrumentB,memo:memoB,requestedAt:new Date().toISOString(),executeBefore:deadline}),{onRetry:delayMs=>setLiquidityStatus(\"Transfer B preparation rate limited. Retrying in \".concat(Math.ceil(delayMs/1000),\"s\")),beforeAttempt:()=>waitForLoopCooldown('prepare B')});const commandsB=extractPreparedCommands(preparedB);if(commandsB.length===0){setLiquidityResult({ok:false,error:{code:'PREPARE_B',message:'Transfer preparation returned no commands',details:preparedB}});toast.error('Transfer B preparation failed');return;}console.log('[addLiquidity] submitting TI',{leg:'B',instrumentAdmin:instrumentB.instrumentAdmin,instrumentId:instrumentB.instrumentId,amount:amountForBStr,requestId});const transferB=await submitTxWithRateLimitRetry({commands:commandsB,actAs:extractPreparedActAs(preparedB,partyId),readAs:extractPreparedReadAs(preparedB,partyId),deduplicationKey:\"\".concat(requestId,\"-b\"),memo:memoB,mode:'LEGACY',disclosedContracts:extractPreparedDisclosedContracts(preparedB),packageIdSelectionPreference:extractPreparedPackagePreference(preparedB),synchronizerId:extractPreparedSynchronizerId(preparedB)},'Transfer B submission',{onRetry:delayMs=>setLiquidityStatus(\"Transfer B submission rate limited. Retrying in \".concat(Math.ceil(delayMs/1000),\"s\")),beforeAttempt:()=>waitForLoopCooldown('submit B')});let consumeResult=null;if(!transferB.ok){const cancelled=isUserCancelled(transferB.error);const message=cancelled?'Second transfer was cancelled. Liquidity was not submitted.':'Inbound transfer B failed';setLiquidityResult({transferA,transferB,consume:null});toast.error(message);}else if(((_transferB$value=transferB.value)===null||_transferB$value===void 0?void 0:_transferB$value.txStatus)==='SUCCEEDED'){var _consumeResult;setLiquidityStatus('Consuming liquidity (backend)');consumeResult=await backendApi.consumeDevnetLiquidity({requestId,poolCid});if((_consumeResult=consumeResult)!==null&&_consumeResult!==void 0&&_consumeResult.ok){var _consumeResult2,_consumeResult2$resul,_consumeResult3,_consumeResult3$resul,_consumeResult4,_consumeResult4$resul;setLiquidityStatus('Liquidity added. LP minted.');toast.success('Liquidity added successfully');console.log('[addLiquidity] consume ok',{lpMinted:(_consumeResult2=consumeResult)===null||_consumeResult2===void 0?void 0:(_consumeResult2$resul=_consumeResult2.result)===null||_consumeResult2$resul===void 0?void 0:_consumeResult2$resul.lpMinted,lpOwnerParty:((_consumeResult3=consumeResult)===null||_consumeResult3===void 0?void 0:(_consumeResult3$resul=_consumeResult3.result)===null||_consumeResult3$resul===void 0?void 0:_consumeResult3$resul.lpOwnerParty)||((_consumeResult4=consumeResult)===null||_consumeResult4===void 0?void 0:(_consumeResult4$resul=_consumeResult4.result)===null||_consumeResult4$resul===void 0?void 0:_consumeResult4$resul.providerParty)});if(typeof window!=='undefined'){window.dispatchEvent(new CustomEvent('clearportx:transactions:refresh',{detail:{source:'liquidity:add',requestId}}));}await refreshLedger('liquidity',poolCid);}else{var _consumeResult5,_consumeResult5$error,_consumeResult6,_consumeResult6$error;if(((_consumeResult5=consumeResult)===null||_consumeResult5===void 0?void 0:(_consumeResult5$error=_consumeResult5.error)===null||_consumeResult5$error===void 0?void 0:_consumeResult5$error.code)==='MISSING_INBOUND_TIS_FOR_POOL_INSTRUMENT'){try{const inspect=await backendApi.inspectDevnetLiquidity(requestId,poolCid);console.log('[addLiquidity] inspect',inspect);}catch(inspectError){console.warn('[addLiquidity] inspect failed',inspectError);}}toast.error(((_consumeResult6=consumeResult)===null||_consumeResult6===void 0?void 0:(_consumeResult6$error=_consumeResult6.error)===null||_consumeResult6$error===void 0?void 0:_consumeResult6$error.message)||'Liquidity consume failed');}}else{toast.error('Inbound transfer B failed');}setLiquidityResult({transferA,transferB,consume:consumeResult});}const updatedPools=await backendApi.getPools();setRawPools(updatedPools);await refreshWalletState();setAmountA('');setAmountB('');setTimeout(()=>{navigate('/pools');},1500);}catch(error){var _error$response,_error$response2,_error$response2$data,_error$response3,_error$response3$data,_error$response4,_error$response5,_error$response6,_error$response7;console.error('Error adding liquidity:',error);console.error('Error response:',(_error$response=error.response)===null||_error$response===void 0?void 0:_error$response.data);const backendMessage=(_error$response2=error.response)===null||_error$response2===void 0?void 0:(_error$response2$data=_error$response2.data)===null||_error$response2$data===void 0?void 0:_error$response2$data.message;const backendDetails=(_error$response3=error.response)===null||_error$response3===void 0?void 0:(_error$response3$data=_error$response3.data)===null||_error$response3$data===void 0?void 0:_error$response3$data.details;const detailSuffix=backendDetails?\" (\".concat(backendDetails,\")\"):'';const composedMessage=backendMessage?\"\".concat(backendMessage).concat(detailSuffix):null;if(composedMessage){toast.error(\"Failed: \".concat(composedMessage));}else if(((_error$response4=error.response)===null||_error$response4===void 0?void 0:_error$response4.status)===422){toast.error('Invalid amounts. Check your token balances.');}else if(((_error$response5=error.response)===null||_error$response5===void 0?void 0:_error$response5.status)===429){toast.error('Rate limit exceeded. Please wait and try again.');}else if(((_error$response6=error.response)===null||_error$response6===void 0?void 0:_error$response6.status)===401){toast.error('Authentication required. Please connect your wallet.');}else if(((_error$response7=error.response)===null||_error$response7===void 0?void 0:_error$response7.status)===404){toast.error('Pool not found. Please select a valid pool.');}else{toast.error('An error occurred while adding liquidity');}}finally{setIsSubmittingLiquidity(false);setLoading(false);}};const existingPool=useMemo(()=>pools.find(p=>p.tokenA.symbol===(selectedTokenA===null||selectedTokenA===void 0?void 0:selectedTokenA.symbol)&&p.tokenB.symbol===(selectedTokenB===null||selectedTokenB===void 0?void 0:selectedTokenB.symbol)||p.tokenA.symbol===(selectedTokenB===null||selectedTokenB===void 0?void 0:selectedTokenB.symbol)&&p.tokenB.symbol===(selectedTokenA===null||selectedTokenA===void 0?void 0:selectedTokenA.symbol))||null,[pools,selectedTokenA,selectedTokenB]);const estimatedLPTokens=useMemo(()=>{const valueA=parseFloat(amountA);const valueB=parseFloat(amountB);if(!Number.isFinite(valueA)||!Number.isFinite(valueB)||valueA<=0||valueB<=0){return 0;}if(!existingPool||existingPool.totalLiquidity<=0||existingPool.reserveA<=0||existingPool.reserveB<=0){return Math.sqrt(valueA*valueB);}const shareA=valueA*existingPool.totalLiquidity/existingPool.reserveA;const shareB=valueB*existingPool.totalLiquidity/existingPool.reserveB;return Math.min(shareA,shareB);},[amountA,amountB,existingPool]);const poolShare=existingPool&&estimatedLPTokens?estimatedLPTokens/(existingPool.totalLiquidity+estimatedLPTokens)*100:100;return/*#__PURE__*/_jsxs(\"div\",{className:\"max-w-2xl mx-auto space-y-6\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"flex items-center justify-between\",children:[/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsx(\"h1\",{className:\"heading-2\",children:\"Manage Liquidity\"}),/*#__PURE__*/_jsx(\"p\",{className:\"body-small mt-1\",children:\"Add or remove liquidity from pools\"})]}),/*#__PURE__*/_jsx(\"button\",{onClick:()=>navigate('/pools'),className:\"btn-secondary px-4 py-2\",children:\"\\u2190 Back to Pools\"})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"glass-strong rounded-2xl p-2 flex space-x-2\",children:[/*#__PURE__*/_jsx(\"button\",{onClick:()=>setMode('add'),className:\"flex-1 py-3 px-4 rounded-xl font-semibold transition-all duration-200 \".concat(mode==='add'?'bg-primary-500 text-white shadow-lg':'bg-transparent text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-dark-800'),children:\"Add Liquidity\"}),/*#__PURE__*/_jsx(\"button\",{onClick:()=>setMode('remove'),className:\"flex-1 py-3 px-4 rounded-xl font-semibold transition-all duration-200 \".concat(mode==='remove'?'bg-primary-500 text-white shadow-lg':'bg-transparent text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-dark-800'),children:\"Remove Liquidity\"})]}),mode==='add'&&/*#__PURE__*/_jsxs(\"div\",{className:\"card-glow bg-white dark:bg-dark-900 relative overflow-hidden\",children:[/*#__PURE__*/_jsx(\"div\",{className:\"absolute inset-0 bg-mesh opacity-30\"}),/*#__PURE__*/_jsxs(\"div\",{className:\"relative space-y-4\",children:[/*#__PURE__*/_jsx(\"h2\",{className:\"heading-3 mb-4\",children:\"Add Liquidity\"}),/*#__PURE__*/_jsxs(\"div\",{className:\"glass-subtle rounded-2xl p-4\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"flex items-center justify-between mb-3\",children:[/*#__PURE__*/_jsx(\"span\",{className:\"body-small\",children:\"Token A\"}),/*#__PURE__*/_jsxs(\"span\",{className:\"body-small\",children:[\"Balance: \",formatBalanceDisplay(selectedTokenA===null||selectedTokenA===void 0?void 0:selectedTokenA.symbol),balancesRefreshing&&/*#__PURE__*/_jsx(\"span\",{className:\"ml-2 text-xs text-gray-500\",children:\"Updating...\"})]})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"flex items-center space-x-3\",children:[/*#__PURE__*/_jsx(\"button\",{onClick:()=>setShowTokenASelector(true),className:\"flex items-center space-x-2 px-3 py-2 rounded-xl bg-gray-100 dark:bg-dark-800 hover:bg-gray-200 dark:hover:bg-dark-700 transition-colors duration-200 min-w-fit whitespace-nowrap\",children:selectedTokenA?/*#__PURE__*/_jsxs(_Fragment,{children:[renderTokenBadge(selectedTokenA,'bg-primary-100 dark:bg-primary-900/20','text-primary-600 dark:text-primary-400'),/*#__PURE__*/_jsx(\"span\",{className:\"font-semibold text-gray-900 dark:text-gray-100\",children:selectedTokenA.symbol})]}):/*#__PURE__*/_jsx(\"span\",{className:\"text-gray-500\",children:\"Select token\"})}),/*#__PURE__*/_jsx(\"input\",{type:\"text\",value:amountA,onChange:e=>setAmountA(e.target.value),placeholder:\"0.0\",className:\"w-32 text-right text-xl font-semibold bg-transparent border-none outline-none text-gray-900 dark:text-gray-100 placeholder-gray-400\"})]})]}),/*#__PURE__*/_jsx(\"div\",{className:\"flex justify-center -my-2 relative z-10\",children:/*#__PURE__*/_jsx(\"div\",{className:\"p-3 rounded-xl bg-white dark:bg-dark-900 border-4 border-gray-50 dark:border-dark-950 shadow-lg\",children:/*#__PURE__*/_jsx(\"span\",{className:\"text-2xl\",children:\"+\"})})}),/*#__PURE__*/_jsxs(\"div\",{className:\"glass-subtle rounded-2xl p-4\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"flex items-center justify-between mb-3\",children:[/*#__PURE__*/_jsx(\"span\",{className:\"body-small\",children:\"Token B\"}),/*#__PURE__*/_jsxs(\"span\",{className:\"body-small\",children:[\"Balance: \",formatBalanceDisplay(selectedTokenB===null||selectedTokenB===void 0?void 0:selectedTokenB.symbol),balancesRefreshing&&/*#__PURE__*/_jsx(\"span\",{className:\"ml-2 text-xs text-gray-500\",children:\"Updating...\"})]})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"flex items-center space-x-3\",children:[/*#__PURE__*/_jsx(\"button\",{onClick:()=>setShowTokenBSelector(true),className:\"flex items-center space-x-2 px-3 py-2 rounded-xl bg-gray-100 dark:bg-dark-800 hover:bg-gray-200 dark:hover:bg-dark-700 transition-colors duration-200 min-w-fit whitespace-nowrap\",children:selectedTokenB?/*#__PURE__*/_jsxs(_Fragment,{children:[renderTokenBadge(selectedTokenB,'bg-success-100 dark:bg-success-900/20','text-success-600 dark:text-success-400'),/*#__PURE__*/_jsx(\"span\",{className:\"font-semibold text-gray-900 dark:text-gray-100\",children:selectedTokenB.symbol})]}):/*#__PURE__*/_jsx(\"span\",{className:\"text-gray-500\",children:\"Select token\"})}),/*#__PURE__*/_jsx(\"input\",{type:\"text\",value:calculating?'...':amountB,onChange:e=>setAmountB(e.target.value),placeholder:\"0.0\",disabled:calculating,className:\"w-32 text-right text-xl font-semibold bg-transparent border-none outline-none text-gray-900 dark:text-gray-100 placeholder-gray-400\"})]})]}),existingPool?/*#__PURE__*/_jsxs(\"div\",{className:\"glass-subtle rounded-xl p-4\",children:[/*#__PURE__*/_jsx(\"h4\",{className:\"font-semibold mb-3 text-gray-900 dark:text-gray-100\",children:\"Pool Information\"}),/*#__PURE__*/_jsxs(\"div\",{className:\"space-y-2 body-small\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"flex justify-between\",children:[/*#__PURE__*/_jsx(\"span\",{className:\"text-gray-600 dark:text-gray-400\",children:\"Current Liquidity:\"}),/*#__PURE__*/_jsxs(\"span\",{className:\"font-semibold text-gray-900 dark:text-gray-100\",children:[existingPool.reserveA.toFixed(2),\" \",existingPool.tokenA.symbol,\" / \",existingPool.reserveB.toFixed(2),\" \",existingPool.tokenB.symbol]})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"flex justify-between\",children:[/*#__PURE__*/_jsx(\"span\",{className:\"text-gray-600 dark:text-gray-400\",children:\"Total LP Tokens:\"}),/*#__PURE__*/_jsx(\"span\",{className:\"font-semibold text-gray-900 dark:text-gray-100\",children:existingPool.totalLiquidity.toFixed(4)})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"flex justify-between\",children:[/*#__PURE__*/_jsx(\"span\",{className:\"text-gray-600 dark:text-gray-400\",children:\"APR:\"}),/*#__PURE__*/_jsxs(\"span\",{className:\"font-semibold text-success-600 dark:text-success-400\",children:[existingPool.apr.toFixed(2),\"%\"]})]})]})]}):selectedTokenA&&selectedTokenB?/*#__PURE__*/_jsxs(\"div\",{className:\"glass-subtle rounded-xl p-4 border-2 border-primary-200 dark:border-primary-800\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"flex items-center space-x-2 mb-2\",children:[/*#__PURE__*/_jsx(\"span\",{className:\"text-xl\",children:\"\\u2728\"}),/*#__PURE__*/_jsx(\"h4\",{className:\"font-semibold text-gray-900 dark:text-gray-100\",children:\"Creating New Pool\"})]}),/*#__PURE__*/_jsx(\"p\",{className:\"body-small text-gray-600 dark:text-gray-400\",children:\"You are the first liquidity provider for this pair. The ratio of tokens you add will set the initial price.\"})]}):null,amountA&&amountB&&selectedTokenA&&selectedTokenB&&/*#__PURE__*/_jsxs(\"div\",{className:\"glass-subtle rounded-xl p-4 space-y-2\",children:[/*#__PURE__*/_jsx(\"h4\",{className:\"font-semibold mb-3 text-gray-900 dark:text-gray-100\",children:\"You will receive\"}),/*#__PURE__*/_jsxs(\"div\",{className:\"flex items-center justify-between\",children:[/*#__PURE__*/_jsx(\"span\",{className:\"body-small text-gray-600 dark:text-gray-400\",children:\"LP Tokens:\"}),/*#__PURE__*/_jsx(\"span\",{className:\"text-lg font-bold text-gradient\",children:estimatedLPTokens.toFixed(4)})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"flex items-center justify-between\",children:[/*#__PURE__*/_jsx(\"span\",{className:\"body-small text-gray-600 dark:text-gray-400\",children:\"Pool Share:\"}),/*#__PURE__*/_jsxs(\"span\",{className:\"text-lg font-bold text-primary-600 dark:text-primary-400\",children:[poolShare.toFixed(2),\"%\"]})]})]}),/*#__PURE__*/_jsx(\"button\",{onClick:handleAddLiquidity,disabled:loading||!partyId||!selectedTokenA||!selectedTokenB||!amountA||!amountB,className:\"w-full py-4 rounded-xl font-semibold text-lg transition-all duration-200 \".concat(loading||!partyId||!selectedTokenA||!selectedTokenB||!amountA||!amountB?'bg-gray-200 dark:bg-dark-800 text-gray-400 dark:text-gray-600 cursor-not-allowed':'btn-primary'),children:loading?/*#__PURE__*/_jsxs(\"span\",{className:\"flex items-center justify-center\",children:[/*#__PURE__*/_jsx(\"div\",{className:\"spinner w-5 h-5 mr-2\"}),\"Adding Liquidity...\"]}):!partyId?'Connect Wallet':'Add Liquidity'}),liquidityStatus&&/*#__PURE__*/_jsx(\"div\",{className:\"mt-4 text-sm text-gray-600 dark:text-gray-300\",children:liquidityStatus}),ledgerRefreshStatus&&/*#__PURE__*/_jsx(\"div\",{className:\"mt-2 text-sm text-gray-600 dark:text-gray-300\",children:ledgerRefreshStatus}),(liquidityResult===null||liquidityResult===void 0?void 0:(_liquidityResult$cons=liquidityResult.consume)===null||_liquidityResult$cons===void 0?void 0:_liquidityResult$cons.ok)&&/*#__PURE__*/_jsxs(\"div\",{className:\"mt-4 glass-subtle rounded-xl p-4 text-sm\",children:[/*#__PURE__*/_jsx(\"div\",{className:\"font-semibold text-gray-900 dark:text-gray-100\",children:\"Liquidity added successfully.\"}),/*#__PURE__*/_jsxs(\"div\",{className:\"mt-2 space-y-1\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"flex justify-between body-small\",children:[/*#__PURE__*/_jsx(\"span\",{className:\"text-gray-600 dark:text-gray-400\",children:\"LP Minted:\"}),/*#__PURE__*/_jsx(\"span\",{className:\"font-semibold text-gray-900 dark:text-gray-100\",children:(_liquidityResult$cons2=liquidityResult.consume.result)===null||_liquidityResult$cons2===void 0?void 0:_liquidityResult$cons2.lpMinted})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"flex justify-between body-small\",children:[/*#__PURE__*/_jsx(\"span\",{className:\"text-gray-600 dark:text-gray-400\",children:\"New Reserve A:\"}),/*#__PURE__*/_jsx(\"span\",{className:\"font-semibold text-gray-900 dark:text-gray-100\",children:(_liquidityResult$cons3=liquidityResult.consume.result)===null||_liquidityResult$cons3===void 0?void 0:_liquidityResult$cons3.newReserveA})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"flex justify-between body-small\",children:[/*#__PURE__*/_jsx(\"span\",{className:\"text-gray-600 dark:text-gray-400\",children:\"New Reserve B:\"}),/*#__PURE__*/_jsx(\"span\",{className:\"font-semibold text-gray-900 dark:text-gray-100\",children:(_liquidityResult$cons4=liquidityResult.consume.result)===null||_liquidityResult$cons4===void 0?void 0:_liquidityResult$cons4.newReserveB})]})]})]}),(liquidityResult===null||liquidityResult===void 0?void 0:liquidityResult.consume)&&!liquidityResult.consume.ok&&/*#__PURE__*/_jsx(\"div\",{className:\"mt-4 text-sm text-error-600 dark:text-error-400\",children:((_liquidityResult$cons5=liquidityResult.consume.error)===null||_liquidityResult$cons5===void 0?void 0:_liquidityResult$cons5.message)||'Liquidity consume failed.'})]})]}),mode==='remove'&&/*#__PURE__*/_jsxs(\"div\",{className:\"card text-center py-12\",children:[/*#__PURE__*/_jsx(\"p\",{className:\"text-gray-500 dark:text-gray-400 mb-2\",children:\"Remove liquidity feature coming soon...\"}),/*#__PURE__*/_jsx(\"p\",{className:\"body-small text-gray-400\",children:\"You'll be able to remove liquidity and claim your tokens + earned fees\"})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"glass-strong rounded-2xl p-6\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"flex items-center justify-between mb-4\",children:[/*#__PURE__*/_jsx(\"h2\",{className:\"heading-3\",children:\"Your Liquidity Positions\"}),/*#__PURE__*/_jsx(\"button\",{type:\"button\",onClick:handleResetLiquidityView,className:\"text-sm font-semibold text-primary-600 hover:text-primary-700 dark:text-primary-400 dark:hover:text-primary-300 transition-colors\",children:\"Re-sync view\"})]}),pools.filter(p=>p.userLiquidity&&p.userLiquidity>0).length===0?/*#__PURE__*/_jsxs(\"div\",{className:\"text-center py-8\",children:[/*#__PURE__*/_jsx(\"div\",{className:\"text-4xl mb-3\"}),/*#__PURE__*/_jsx(\"p\",{className:\"text-gray-500 dark:text-gray-400\",children:\"You don't have any liquidity positions yet\"})]}):/*#__PURE__*/_jsx(\"div\",{className:\"space-y-3\",children:pools.filter(p=>p.userLiquidity&&p.userLiquidity>0).map(pool=>{var _pool$userLiquidity,_pool$userShare;return/*#__PURE__*/_jsx(\"div\",{className:\"glass-subtle rounded-xl p-4\",children:/*#__PURE__*/_jsxs(\"div\",{className:\"flex items-center justify-between\",children:[/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsxs(\"h4\",{className:\"font-bold text-gray-900 dark:text-gray-100\",children:[pool.tokenA.symbol,\"/\",pool.tokenB.symbol]}),/*#__PURE__*/_jsxs(\"p\",{className:\"body-small\",children:[(_pool$userLiquidity=pool.userLiquidity)===null||_pool$userLiquidity===void 0?void 0:_pool$userLiquidity.toFixed(4),\" LP Tokens \\u2022 \",(_pool$userShare=pool.userShare)===null||_pool$userShare===void 0?void 0:_pool$userShare.toFixed(2),\"% of pool\"]})]}),/*#__PURE__*/_jsx(\"button\",{className:\"btn-secondary px-4 py-2\",children:\"Remove\"})]})},pool.contractId);})}),/*#__PURE__*/_jsxs(\"div\",{className:\"mt-6\",children:[/*#__PURE__*/_jsx(\"h3\",{className:\"font-semibold text-gray-900 dark:text-gray-100 mb-2\",children:\"Your LP (ledger)\"}),lpPositions.length===0?/*#__PURE__*/_jsx(\"p\",{className:\"text-sm text-gray-500 dark:text-gray-400\",children:\"No LP positions detected yet.\"}):/*#__PURE__*/_jsx(\"div\",{className:\"space-y-2\",children:lpPositions.map(position=>/*#__PURE__*/_jsxs(\"div\",{className:\"flex items-center justify-between glass-subtle rounded-xl p-3\",children:[/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsx(\"div\",{className:\"font-semibold text-gray-900 dark:text-gray-100\",children:resolvePoolLabel(position.poolCid)}),/*#__PURE__*/_jsxs(\"div\",{className:\"body-small text-gray-600 dark:text-gray-400\",children:[\"LP Balance: \",formatLpBalance(position.lpBalance),\" \\u2022 Share: \",formatShareBps(position.shareBps)]})]}),position.updatedAt&&/*#__PURE__*/_jsxs(\"div\",{className:\"text-xs text-gray-500 dark:text-gray-400\",children:[\"Updated \",new Date(position.updatedAt).toLocaleTimeString('en-US')]})]},\"\".concat(position.poolCid,\"-\").concat(position.lpBalance)))})]})]}),/*#__PURE__*/_jsx(TokenSelector,{isOpen:showTokenASelector,onClose:()=>setShowTokenASelector(false),tokens:tokens,selectedToken:selectedTokenA,type:\"from\",balances:balancesBySymbol,onSelect:token=>{setSelectedTokenA(token);if(token.symbol===(selectedTokenB===null||selectedTokenB===void 0?void 0:selectedTokenB.symbol)){setSelectedTokenB(null);}setShowTokenASelector(false);}}),/*#__PURE__*/_jsx(TokenSelector,{isOpen:showTokenBSelector,onClose:()=>setShowTokenBSelector(false),tokens:tokenBOptions,selectedToken:selectedTokenB,type:\"to\",balances:balancesBySymbol,onSelect:token=>{setSelectedTokenB(token);setShowTokenBSelector(false);}})]});};async function prepareLoopTransfer(provider,params){var _provider$auth_token,_provider$connection,_provider$sdk,_params$requestedAt;if(!provider){throw new Error('Loop provider is not connected');}const authToken=(_provider$auth_token=provider.auth_token)!==null&&_provider$auth_token!==void 0?_provider$auth_token:provider.authToken;const connection=(_provider$connection=provider.connection)!==null&&_provider$connection!==void 0?_provider$connection:provider===null||provider===void 0?void 0:(_provider$sdk=provider.sdk)===null||_provider$sdk===void 0?void 0:_provider$sdk.connection;const prepareTransfer=connection===null||connection===void 0?void 0:connection.prepareTransfer;if(!authToken||typeof prepareTransfer!=='function'){throw new Error('Loop provider does not expose transfer preparation');}const payload={recipient:params.recipient,amount:params.amount,instrument:{instrument_admin:params.instrument.instrumentAdmin,instrument_id:params.instrument.instrumentId},requested_at:(_params$requestedAt=params.requestedAt)!==null&&_params$requestedAt!==void 0?_params$requestedAt:new Date().toISOString(),execute_before:params.executeBefore,memo:params.memo};return prepareTransfer.call(connection,authToken,payload);}const LOOP_RATE_LIMIT_RETRY_DELAYS_MS=[2000,4000,7000,12000];const LOOP_MIN_GAP_MS=4000;function sleep(ms){return new Promise(resolve=>setTimeout(resolve,ms));}function isLoopRateLimitError(err){var _ref2,_ref3,_err$response$status,_err$response,_err$error,_err$error$response,_err$details,_err$details$response,_ref4,_ref5,_ref6,_err$message,_err$error2,_err$details2,_err$details3,_err$details3$toStrin;const status=(_ref2=(_ref3=(_err$response$status=err===null||err===void 0?void 0:(_err$response=err.response)===null||_err$response===void 0?void 0:_err$response.status)!==null&&_err$response$status!==void 0?_err$response$status:err===null||err===void 0?void 0:err.status)!==null&&_ref3!==void 0?_ref3:err===null||err===void 0?void 0:(_err$error=err.error)===null||_err$error===void 0?void 0:(_err$error$response=_err$error.response)===null||_err$error$response===void 0?void 0:_err$error$response.status)!==null&&_ref2!==void 0?_ref2:err===null||err===void 0?void 0:(_err$details=err.details)===null||_err$details===void 0?void 0:(_err$details$response=_err$details.response)===null||_err$details$response===void 0?void 0:_err$details$response.status;if(status===429){return true;}const message=String((_ref4=(_ref5=(_ref6=(_err$message=err===null||err===void 0?void 0:err.message)!==null&&_err$message!==void 0?_err$message:err===null||err===void 0?void 0:(_err$error2=err.error)===null||_err$error2===void 0?void 0:_err$error2.message)!==null&&_ref6!==void 0?_ref6:err===null||err===void 0?void 0:(_err$details2=err.details)===null||_err$details2===void 0?void 0:_err$details2.message)!==null&&_ref5!==void 0?_ref5:err===null||err===void 0?void 0:(_err$details3=err.details)===null||_err$details3===void 0?void 0:(_err$details3$toStrin=_err$details3.toString)===null||_err$details3$toStrin===void 0?void 0:_err$details3$toStrin.call(_err$details3))!==null&&_ref4!==void 0?_ref4:'').toLowerCase();return message.includes('429')||message.includes('rate limit');}function isUserCancelled(err){var _ref7,_err$code,_err$message2;if(!err){return false;}const code=String((_ref7=(_err$code=err.code)!==null&&_err$code!==void 0?_err$code:err.name)!==null&&_ref7!==void 0?_ref7:'').toLowerCase();const message=String((_err$message2=err.message)!==null&&_err$message2!==void 0?_err$message2:'').toLowerCase();return code.includes('cancel')||code.includes('reject')||message.includes('cancel')||message.includes('rejected')||message.includes('user rejected');}function extractRetryAfterMs(err){var _ref8,_ref9,_err$response$headers,_err$response2,_err$error3,_err$error3$response,_err$details4,_err$details4$respons,_ref0,_headers$retryAfter;const headers=(_ref8=(_ref9=(_err$response$headers=err===null||err===void 0?void 0:(_err$response2=err.response)===null||_err$response2===void 0?void 0:_err$response2.headers)!==null&&_err$response$headers!==void 0?_err$response$headers:err===null||err===void 0?void 0:err.headers)!==null&&_ref9!==void 0?_ref9:err===null||err===void 0?void 0:(_err$error3=err.error)===null||_err$error3===void 0?void 0:(_err$error3$response=_err$error3.response)===null||_err$error3$response===void 0?void 0:_err$error3$response.headers)!==null&&_ref8!==void 0?_ref8:err===null||err===void 0?void 0:(_err$details4=err.details)===null||_err$details4===void 0?void 0:(_err$details4$respons=_err$details4.response)===null||_err$details4$respons===void 0?void 0:_err$details4$respons.headers;if(!headers)return null;const retryAfter=(_ref0=(_headers$retryAfter=headers['retry-after'])!==null&&_headers$retryAfter!==void 0?_headers$retryAfter:headers['Retry-After'])!==null&&_ref0!==void 0?_ref0:headers['RETRY-AFTER'];if(!retryAfter)return null;if(typeof retryAfter==='number'){return Math.max(0,retryAfter*1000);}const retryAfterStr=String(retryAfter).trim();const asNumber=Number(retryAfterStr);if(Number.isFinite(asNumber)){return Math.max(0,asNumber*1000);}const asDate=Date.parse(retryAfterStr);if(!Number.isNaN(asDate)){return Math.max(0,asDate-Date.now());}return null;}function resolveRateLimitDelayMs(err,fallbackMs){const retryAfterMs=extractRetryAfterMs(err);return retryAfterMs&&Number.isFinite(retryAfterMs)&&retryAfterMs>0?retryAfterMs:fallbackMs;}async function withLoopRateLimitRetry(label,task,options){for(let attempt=0;attempt<=LOOP_RATE_LIMIT_RETRY_DELAYS_MS.length;attempt+=1){try{if(options!==null&&options!==void 0&&options.beforeAttempt){await options.beforeAttempt();}return await task();}catch(err){var _options$onRetry;if(!isLoopRateLimitError(err)||attempt>=LOOP_RATE_LIMIT_RETRY_DELAYS_MS.length){throw err;}const delayMs=resolveRateLimitDelayMs(err,LOOP_RATE_LIMIT_RETRY_DELAYS_MS[attempt]);console.warn(\"[loop] \".concat(label,\" rate limited (429). Retrying in \").concat(delayMs,\"ms.\"));options===null||options===void 0?void 0:(_options$onRetry=options.onRetry)===null||_options$onRetry===void 0?void 0:_options$onRetry.call(options,delayMs);await sleep(delayMs);}}throw new Error(\"[loop] \".concat(label,\" failed after rate limit retries\"));}async function submitTxWithRateLimitRetry(input,label,options){for(let attempt=0;attempt<=LOOP_RATE_LIMIT_RETRY_DELAYS_MS.length;attempt+=1){var _result$error$details,_result$error,_options$onRetry2;if(options!==null&&options!==void 0&&options.beforeAttempt){await options.beforeAttempt();}const result=await submitTx(input);if(result.ok||!isLoopRateLimitError(result.error)){return result;}if(attempt>=LOOP_RATE_LIMIT_RETRY_DELAYS_MS.length){return result;}const delayMs=resolveRateLimitDelayMs((_result$error$details=(_result$error=result.error)===null||_result$error===void 0?void 0:_result$error.details)!==null&&_result$error$details!==void 0?_result$error$details:result.error,LOOP_RATE_LIMIT_RETRY_DELAYS_MS[attempt]);console.warn(\"[loop] \".concat(label,\" rate limited (429). Retrying in \").concat(delayMs,\"ms.\"));options===null||options===void 0?void 0:(_options$onRetry2=options.onRetry)===null||_options$onRetry2===void 0?void 0:_options$onRetry2.call(options,delayMs);await sleep(delayMs);}return submitTx(input);}function extractPreparedCommands(prepared){var _ref1,_ref10,_ref11,_prepared$commands,_prepared$payload,_prepared$commandPayl,_prepared$command_pay;const commands=(_ref1=(_ref10=(_ref11=(_prepared$commands=prepared===null||prepared===void 0?void 0:prepared.commands)!==null&&_prepared$commands!==void 0?_prepared$commands:prepared===null||prepared===void 0?void 0:(_prepared$payload=prepared.payload)===null||_prepared$payload===void 0?void 0:_prepared$payload.commands)!==null&&_ref11!==void 0?_ref11:prepared===null||prepared===void 0?void 0:(_prepared$commandPayl=prepared.commandPayload)===null||_prepared$commandPayl===void 0?void 0:_prepared$commandPayl.commands)!==null&&_ref10!==void 0?_ref10:prepared===null||prepared===void 0?void 0:(_prepared$command_pay=prepared.command_payload)===null||_prepared$command_pay===void 0?void 0:_prepared$command_pay.commands)!==null&&_ref1!==void 0?_ref1:[];return Array.isArray(commands)?commands:[];}function extractPreparedDisclosedContracts(prepared){var _ref12,_ref13,_ref14,_ref15,_prepared$disclosedCo,_prepared$extraArgs,_prepared$extra_args,_prepared$payload2,_prepared$payload3;const disclosed=(_ref12=(_ref13=(_ref14=(_ref15=(_prepared$disclosedCo=prepared===null||prepared===void 0?void 0:prepared.disclosedContracts)!==null&&_prepared$disclosedCo!==void 0?_prepared$disclosedCo:prepared===null||prepared===void 0?void 0:prepared.disclosed_contracts)!==null&&_ref15!==void 0?_ref15:prepared===null||prepared===void 0?void 0:(_prepared$extraArgs=prepared.extraArgs)===null||_prepared$extraArgs===void 0?void 0:_prepared$extraArgs.disclosedContracts)!==null&&_ref14!==void 0?_ref14:prepared===null||prepared===void 0?void 0:(_prepared$extra_args=prepared.extra_args)===null||_prepared$extra_args===void 0?void 0:_prepared$extra_args.disclosed_contracts)!==null&&_ref13!==void 0?_ref13:prepared===null||prepared===void 0?void 0:(_prepared$payload2=prepared.payload)===null||_prepared$payload2===void 0?void 0:_prepared$payload2.disclosedContracts)!==null&&_ref12!==void 0?_ref12:prepared===null||prepared===void 0?void 0:(_prepared$payload3=prepared.payload)===null||_prepared$payload3===void 0?void 0:_prepared$payload3.disclosed_contracts;return Array.isArray(disclosed)?disclosed:undefined;}function extractPreparedPackagePreference(prepared){var _ref16,_ref17,_ref18,_ref19,_prepared$packageIdSe,_prepared$payload4,_prepared$payload5;const pref=(_ref16=(_ref17=(_ref18=(_ref19=(_prepared$packageIdSe=prepared===null||prepared===void 0?void 0:prepared.packageIdSelectionPreference)!==null&&_prepared$packageIdSe!==void 0?_prepared$packageIdSe:prepared===null||prepared===void 0?void 0:prepared.package_id_selection_preference)!==null&&_ref19!==void 0?_ref19:prepared===null||prepared===void 0?void 0:prepared.packageIdSelection)!==null&&_ref18!==void 0?_ref18:prepared===null||prepared===void 0?void 0:prepared.package_id_selection)!==null&&_ref17!==void 0?_ref17:prepared===null||prepared===void 0?void 0:(_prepared$payload4=prepared.payload)===null||_prepared$payload4===void 0?void 0:_prepared$payload4.packageIdSelectionPreference)!==null&&_ref16!==void 0?_ref16:prepared===null||prepared===void 0?void 0:(_prepared$payload5=prepared.payload)===null||_prepared$payload5===void 0?void 0:_prepared$payload5.package_id_selection_preference;return Array.isArray(pref)?pref:undefined;}function extractPreparedSynchronizerId(prepared){var _ref20,_prepared$synchronize;return(_ref20=(_prepared$synchronize=prepared===null||prepared===void 0?void 0:prepared.synchronizerId)!==null&&_prepared$synchronize!==void 0?_prepared$synchronize:prepared===null||prepared===void 0?void 0:prepared.synchronizer_id)!==null&&_ref20!==void 0?_ref20:undefined;}function extractPreparedActAs(prepared,fallback){var _ref21,_ref22,_prepared$actAs;const actAs=(_ref21=(_ref22=(_prepared$actAs=prepared===null||prepared===void 0?void 0:prepared.actAs)!==null&&_prepared$actAs!==void 0?_prepared$actAs:prepared===null||prepared===void 0?void 0:prepared.act_as)!==null&&_ref22!==void 0?_ref22:prepared===null||prepared===void 0?void 0:prepared.actAsParties)!==null&&_ref21!==void 0?_ref21:prepared===null||prepared===void 0?void 0:prepared.act_as_parties;if(Array.isArray(actAs)&&actAs.length>0){return actAs;}if(typeof actAs==='string'&&actAs.length>0){return actAs;}return fallback;}function extractPreparedReadAs(prepared,fallback){var _ref23,_ref24,_prepared$readAs;const readAs=(_ref23=(_ref24=(_prepared$readAs=prepared===null||prepared===void 0?void 0:prepared.readAs)!==null&&_prepared$readAs!==void 0?_prepared$readAs:prepared===null||prepared===void 0?void 0:prepared.read_as)!==null&&_ref24!==void 0?_ref24:prepared===null||prepared===void 0?void 0:prepared.readAsParties)!==null&&_ref23!==void 0?_ref23:prepared===null||prepared===void 0?void 0:prepared.read_as_parties;if(Array.isArray(readAs)&&readAs.length>0){return readAs;}if(typeof readAs==='string'&&readAs.length>0){return readAs;}return fallback?[fallback]:undefined;}export default LiquidityInterface;","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}