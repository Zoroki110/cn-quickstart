{"ast":null,"code":"import _objectSpread from\"/root/cn-quickstart/quickstart/frontend/node_modules/@babel/runtime/helpers/esm/objectSpread2.js\";import React,{useState,useEffect,useMemo,useCallback,useRef}from'react';import{useAppStore}from'../stores';import{useContractStore}from'../stores/useContractStore';import{backendApi}from'../services/backendApi';import TokenSelector from'./TokenSelector';import SlippageSettings from'./SlippageSettings';import toast from'react-hot-toast';import{useWalletAuth,walletManager}from'../wallet';import{useLoopBalances,useUtxoBalances}from'../hooks';import{submitTx}from'../loop/submitTx';import{getLoopProvider}from'../loop/loopProvider';import{calculateSwapQuoteFromPool}from'../utils/poolMath';import{balancesKeyFromMap,lpKeyFromPositions,poolKeyFromPools,refreshLedgerState}from'../utils/refreshLedgerState';import{jsx as _jsx,jsxs as _jsxs,Fragment as _Fragment}from\"react/jsx-runtime\";const AMULET_ADMIN='DSO::1220be58c29e65de40bf273be1dc2b266d43a9a002ea5b18955aeef7aac881bb471a';const AMULET_ID='Amulet';const CBTC_ADMIN='cbtc-network::12202a83c6f4082217c175e29bc53da5f2703ba2675778ab99217a5a881a949203ff';const CBTC_ID='CBTC';const OPERATOR_PARTY=process.env.REACT_APP_OPERATOR_PARTY||process.env.REACT_APP_OPERATOR_PARTY_ID||'ClearportX-DEX-1::122081f2b8e29cbe57d1037a18e6f70e57530773b3a4d1bea6bab981b7a76e943b37';const SwapInterface=()=>{var _swapResult$consume,_selectedTokens$from,_selectedTokens$to,_selectedTokens$from2,_selectedTokens$to2,_selectedTokens$from3,_consumePayload$amoun,_consumePayload$payou;const{selectedTokens,setSelectedTokens,swapTokens:swapSelectedTokens,slippage}=useAppStore();const{partyId,walletType}=useWalletAuth();const partyForBackend=walletType==='loop'?null:partyId||null;const{balances:loopBalances,reload:reloadLoopBalances,isRefreshing:loopRefreshing}=useLoopBalances(partyId||null,walletType,{refreshIntervalMs:15000});const{balances:utxoBalances,reload:reloadUtxoBalances,isRefreshing:utxoRefreshing}=useUtxoBalances(partyForBackend,{ownerOnly:true,refreshIntervalMs:15000});const reloadBalances=useCallback(async()=>{if(walletType==='loop'){await reloadLoopBalances();return;}await reloadUtxoBalances();},[walletType,reloadLoopBalances,reloadUtxoBalances]);const[inputAmount,setInputAmount]=useState('');const[outputAmount,setOutputAmount]=useState('');const[tokens,setTokens]=useState([]);const[quote,setQuote]=useState(null);const[loading,setLoading]=useState(false);const[calculating,setCalculating]=useState(false);const[showFromSelector,setShowFromSelector]=useState(false);const[showToSelector,setShowToSelector]=useState(false);const[showSettings,setShowSettings]=useState(false);const[swapResult,setSwapResult]=useState(null);const[swapStatus,setSwapStatus]=useState(null);const[devnetConsumeAvailable,setDevnetConsumeAvailable]=useState(false);const[pools,setPools]=useState([]);const[volume24h,setVolume24h]=useState(0);const[lpPositions,setLpPositions]=useState([]);const[ledgerRefreshStatus,setLedgerRefreshStatus]=useState(null);const lastConnectedParty=useRef(null);const balancesSnapshotRef=useRef('');const poolSnapshotRef=useRef('');const lpSnapshotRef=useRef('');const resolvedPoolId=useMemo(()=>{var _match$contractId;if(!selectedTokens.from||!selectedTokens.to||pools.length===0)return null;const fromSymbol=selectedTokens.from.symbol.toUpperCase();const toSymbol=selectedTokens.to.symbol.toUpperCase();const match=pools.find(pool=>{const symbolA=pool.tokenA.symbol.toUpperCase();const symbolB=pool.tokenB.symbol.toUpperCase();return symbolA===fromSymbol&&symbolB===toSymbol||symbolA===toSymbol&&symbolB===fromSymbol;});return(_match$contractId=match===null||match===void 0?void 0:match.contractId)!==null&&_match$contractId!==void 0?_match$contractId:null;},[pools,selectedTokens.from,selectedTokens.to]);const activePool=useMemo(()=>{var _pools$find;if(!resolvedPoolId){return null;}return(_pools$find=pools.find(pool=>pool.contractId===resolvedPoolId||pool.poolId===resolvedPoolId))!==null&&_pools$find!==void 0?_pools$find:null;},[pools,resolvedPoolId]);const formatCurrency=value=>{if(!isFinite(value)||value<=0)return'$0';if(value>=1000000)return\"$\".concat((value/1000000).toFixed(1),\"M\");if(value>=1000)return\"$\".concat((value/1000).toFixed(1),\"K\");return\"$\".concat(value.toFixed(0));};const balancesBySymbol=useMemo(()=>{if(walletType==='loop'){const map={};Object.entries(loopBalances).forEach(_ref=>{let[symbol,entry]=_ref;map[symbol.toUpperCase()]={amount:entry.amount,decimals:entry.decimals};});return map;}const map={};Object.values(utxoBalances).forEach(entry=>{var _existing$decimals;const symbol=instrumentIdToSymbol(entry.instrumentId);const existing=map[symbol];map[symbol]={amount:existing?decimalAddStrings(existing.amount,entry.amount):entry.amount,decimals:(_existing$decimals=existing===null||existing===void 0?void 0:existing.decimals)!==null&&_existing$decimals!==void 0?_existing$decimals:entry.decimals};});return map;},[walletType,loopBalances,utxoBalances]);const balancesRefreshing=walletType==='loop'?loopRefreshing:utxoRefreshing;useEffect(()=>{balancesSnapshotRef.current=balancesKeyFromMap(balancesBySymbol);},[balancesBySymbol]);useEffect(()=>{poolSnapshotRef.current=poolKeyFromPools(pools,(activePool===null||activePool===void 0?void 0:activePool.contractId)||resolvedPoolId);},[pools,activePool,resolvedPoolId]);useEffect(()=>{lpSnapshotRef.current=lpKeyFromPositions(lpPositions);},[lpPositions]);const getBalanceEntry=useCallback(symbol=>{if(!symbol){return undefined;}return balancesBySymbol[symbol.toUpperCase()];},[balancesBySymbol]);const formatBalanceDisplay=useCallback(symbol=>{const entry=getBalanceEntry(symbol);if(!entry){return'0.0000';}const numeric=Number(entry.amount);if(!Number.isFinite(numeric)){return entry.amount;}return numeric.toLocaleString('en-US',{maximumFractionDigits:4});},[getBalanceEntry]);const getNumericBalance=useCallback(symbol=>{const entry=getBalanceEntry(symbol);if(!entry){return 0;}const numeric=Number(entry.amount);return Number.isFinite(numeric)?numeric:0;},[getBalanceEntry]);const refreshLedger=useCallback(async(label,poolCid)=>{if(!partyId)return;await refreshLedgerState({label,getSnapshot:()=>({balancesKey:balancesSnapshotRef.current,poolKey:poolSnapshotRef.current,lpKey:lpSnapshotRef.current}),fetchSnapshot:async()=>{var _ref2;await reloadBalances();const latestPools=await backendApi.getPools();setPools(latestPools);const latestPositions=await backendApi.getLpPositions(partyId);setLpPositions(latestPositions);console.log('[lpPositions] loaded',{count:latestPositions.length,first:latestPositions[0]});return{balancesKey:balancesSnapshotRef.current,poolKey:poolKeyFromPools(latestPools,(_ref2=poolCid!==null&&poolCid!==void 0?poolCid:activePool===null||activePool===void 0?void 0:activePool.contractId)!==null&&_ref2!==void 0?_ref2:resolvedPoolId),lpKey:lpKeyFromPositions(latestPositions)};},onStatus:setLedgerRefreshStatus});},[partyId,reloadBalances,activePool,resolvedPoolId]);const parsedInputAmount=parseFloat(inputAmount||'0');const normalizedInputAmount=Number.isFinite(parsedInputAmount)?parsedInputAmount:0;const insufficientBalance=Boolean(partyId&&selectedTokens.from&&normalizedInputAmount>getNumericBalance(selectedTokens.from.symbol));const disableSwap=loading||!partyId||!selectedTokens.from||!selectedTokens.to||!inputAmount||!quote||insufficientBalance;const consumePayload=swapResult===null||swapResult===void 0?void 0:(_swapResult$consume=swapResult.consume)===null||_swapResult$consume===void 0?void 0:_swapResult$consume.result;const payoutStatus=consumePayload===null||consumePayload===void 0?void 0:consumePayload.payoutStatus;const payoutCid=consumePayload===null||consumePayload===void 0?void 0:consumePayload.payoutCid;const payoutMessage=payoutStatus==='COMPLETED'?'Payout completed on ledger (no Loop accept required).':payoutStatus==='CREATED'?'Payout TransferInstruction created. Accept in Loop wallet.':null;useEffect(()=>{const previous=lastConnectedParty.current;if(partyId&&partyId!==previous){reloadBalances();}if(!partyId){lastConnectedParty.current=null;return;}lastConnectedParty.current=partyId;},[partyId,reloadBalances]);useEffect(()=>{if(!partyId){setLpPositions([]);return;}backendApi.getLpPositions(partyId).then(positions=>{setLpPositions(positions);console.log('[lpPositions] loaded',{count:positions.length,first:positions[0]});}).catch(error=>{console.warn('[lpPositions] load failed',error);});},[partyId]);useEffect(()=>{if(typeof window==='undefined'){return;}const handleWalletConnected=()=>{reloadBalances();};window.addEventListener('clearportx:wallet:connected',handleWalletConnected);return()=>{window.removeEventListener('clearportx:wallet:connected',handleWalletConnected);};},[reloadBalances]);// Charger les tokens depuis les pools actifs + balances utilisateur\nuseEffect(()=>{const loadTokens=async()=>{try{const pools=await backendApi.getPools();setPools(pools);const uniqueTokensMap=new Map();pools.forEach(pool=>{if(!uniqueTokensMap.has(pool.tokenA.symbol)){uniqueTokensMap.set(pool.tokenA.symbol,_objectSpread(_objectSpread({},pool.tokenA),{},{balance:0}));}if(!uniqueTokensMap.has(pool.tokenB.symbol)){uniqueTokensMap.set(pool.tokenB.symbol,_objectSpread(_objectSpread({},pool.tokenB),{},{balance:0}));}});const tokensList=Array.from(uniqueTokensMap.values()).map(token=>_objectSpread(_objectSpread({},token),{},{balance:0}));setTokens(tokensList);useContractStore.getState().setTokens(tokensList);}catch(error){console.error('Error loading tokens:',error);toast.error('Failed to load tokens from backend');}};loadTokens();},[]);useEffect(()=>{let cancelled=false;const probeDevnetSwap=async()=>{const res=await backendApi.inspectDevnetSwap('ping');if(cancelled)return;setDevnetConsumeAvailable(isDevnetSwapApiResponse(res));};probeDevnetSwap();return()=>{cancelled=true;};},[]);// Compute 24h volume for selected pair from current pools\nuseEffect(()=>{if(!selectedTokens.from||!selectedTokens.to||pools.length===0){setVolume24h(0);return;}const a=selectedTokens.from.symbol.toUpperCase();const b=selectedTokens.to.symbol.toUpperCase();const match=pools.find(p=>{const pa=p.tokenA.symbol.toUpperCase();const pb=p.tokenB.symbol.toUpperCase();return pa===a&&pb===b||pa===b&&pb===a;});setVolume24h((match===null||match===void 0?void 0:match.volume24h)||0);},[selectedTokens.from,selectedTokens.to,pools]);// Calculer le quote quand le montant change\nuseEffect(()=>{if(!selectedTokens.from||!selectedTokens.to||!inputAmount||!activePool){setOutputAmount('');setQuote(null);return;}const timeout=setTimeout(()=>{setCalculating(true);try{const amount=parseFloat(inputAmount);if(!Number.isFinite(amount)||amount<=0){setOutputAmount('');setQuote(null);return;}const estimatedQuote=calculateSwapQuoteFromPool(activePool,selectedTokens.from.symbol,selectedTokens.to.symbol,amount);if(!estimatedQuote){setOutputAmount('');setQuote(null);return;}setQuote(estimatedQuote);setOutputAmount(estimatedQuote.outputAmount.toFixed(6));}finally{setCalculating(false);}},250);return()=>clearTimeout(timeout);},[inputAmount,selectedTokens.from,selectedTokens.to,activePool]);const handleSwap=async()=>{if(!selectedTokens.from||!selectedTokens.to||!inputAmount||!quote){toast.error('Please fill in all fields');return;}if(!partyId){toast.error('Connect a wallet to swap tokens');return;}if(walletType&&walletType!=='loop'){toast.error('Loop wallet required to submit swaps');return;}const amount=parseFloat(inputAmount);if(isNaN(amount)||amount<=0){toast.error('Please enter a valid amount');return;}const availableBalance=getNumericBalance(selectedTokens.from.symbol);if(amount>availableBalance){toast.error('Insufficient balance for this swap');return;}if(!resolvedPoolId){toast.error('No liquidity pool available for this pair');return;}try{var _disclosedContracts$l;setLoading(true);setSwapResult(null);setSwapStatus(null);const instrument=resolveInstrumentForSymbol(selectedTokens.from.symbol);if(!instrument){toast.error('Unsupported token for swap');return;}const minOutput=quote.outputAmount*(1-slippage/100);const minOutputStr=minOutput.toFixed(10);const poolCid=(activePool===null||activePool===void 0?void 0:activePool.contractId)||resolvedPoolId;const direction=resolveSwapDirection(activePool,selectedTokens.from.symbol,selectedTokens.to.symbol);if(!direction){toast.error('Token selection does not match active pool');return;}const deadline=new Date(Date.now()+10*60*1000).toISOString();const requestId=\"swap-\".concat(Date.now(),\"-\").concat(Math.random().toString(36).slice(2,8));const memoPayload={v:1,requestId,poolCid,direction,minOut:minOutputStr,receiverParty:partyId,deadline};const memo=JSON.stringify(memoPayload);const connector=walletManager.getOrCreateLoopConnector();const status=await connector.ensureConnected(\"swap-\".concat(Date.now()));if(!status.connected||!getLoopProvider()){const message=status.error||'Loop not connected';setSwapResult({ok:false,error:{code:'CONNECT',message}});toast.error(message);return;}const prepared=await prepareLoopTransfer(getLoopProvider(),{recipient:OPERATOR_PARTY,amount:amount.toFixed(10),instrument,memo,requestedAt:new Date().toISOString(),executeBefore:deadline});const commands=extractPreparedCommands(prepared);const disclosedContracts=extractPreparedDisclosedContracts(prepared);const packagePreference=extractPreparedPackagePreference(prepared);const synchronizerId=extractPreparedSynchronizerId(prepared);const exerciseContractId=extractExerciseContractId(commands);const debugInfo={disclosedContractsCount:(_disclosedContracts$l=disclosedContracts===null||disclosedContracts===void 0?void 0:disclosedContracts.length)!==null&&_disclosedContracts$l!==void 0?_disclosedContracts$l:0,contractId:exerciseContractId,synchronizerId,requestId};console.log('[Swap submitTx debug]',debugInfo);if(commands.length===0){setSwapResult({ok:false,error:{code:'PREPARE',message:'Transfer preparation returned no commands',details:prepared}});toast.error('Transfer preparation failed');return;}const combinedCommands=commands;setSwapStatus('Submitting inbound transfer');const transferResult=await submitTx({commands:combinedCommands,actAs:extractPreparedActAs(prepared,partyId),readAs:extractPreparedReadAs(prepared,partyId),deduplicationKey:requestId,memo,mode:'WAIT',disclosedContracts,packageIdSelectionPreference:packagePreference,synchronizerId});let consumeResult=null;let didRefresh=false;if(transferResult.ok&&transferResult.value.txStatus==='SUCCEEDED'){const shouldConsume=devnetConsumeAvailable;if(shouldConsume){var _consumeResult;setSwapStatus('Consuming swap (backend)');consumeResult=await backendApi.consumeDevnetSwap({requestId});if((_consumeResult=consumeResult)!==null&&_consumeResult!==void 0&&_consumeResult.ok){var _consumeResult2,_consumeResult2$resul,_consumeResult3,_consumeResult3$resul;const payoutStatus=(_consumeResult2=consumeResult)===null||_consumeResult2===void 0?void 0:(_consumeResult2$resul=_consumeResult2.result)===null||_consumeResult2$resul===void 0?void 0:_consumeResult2$resul.payoutStatus;const payoutCid=(_consumeResult3=consumeResult)===null||_consumeResult3===void 0?void 0:(_consumeResult3$resul=_consumeResult3.result)===null||_consumeResult3$resul===void 0?void 0:_consumeResult3$resul.payoutCid;if(payoutStatus==='COMPLETED'||!payoutCid){setSwapStatus('Payout completed automatically. No Loop accept required.');}else{setSwapStatus('Payout created. Accept in Loop wallet.');}if(typeof window!=='undefined'){window.dispatchEvent(new CustomEvent('clearportx:transactions:refresh',{detail:{source:'swap',requestId}}));}await refreshLedger('swap',poolCid);didRefresh=true;}}else{consumeResult={ok:false,error:{code:'DEVNET_ONLY',message:'Swap consume is only enabled in devnet'}};}}const resultWithDebug={transfer:transferResult,consume:consumeResult,debug:debugInfo};console.log('[Swap submitTx]',resultWithDebug);setSwapResult(resultWithDebug);if(transferResult.ok&&transferResult.value.txStatus==='SUCCEEDED'){toast.success(\"Transfer submitted (update \".concat(transferResult.value.ledgerUpdateId||'pending',\")\"));setInputAmount('');setOutputAmount('');setQuote(null);if(!didRefresh){await refreshLedger('swap',poolCid);}}else if(transferResult.ok){toast.error('Swap transfer failed');}else{toast.error(transferResult.error.message);}}catch(error){var _ref3,_ref4,_error$message,_error$response,_error$response$data,_error$response2,_error$response2$data;console.error('Error executing swap:',error);const message=(_ref3=(_ref4=(_error$message=error===null||error===void 0?void 0:error.message)!==null&&_error$message!==void 0?_error$message:error===null||error===void 0?void 0:(_error$response=error.response)===null||_error$response===void 0?void 0:(_error$response$data=_error$response.data)===null||_error$response$data===void 0?void 0:_error$response$data.message)!==null&&_ref4!==void 0?_ref4:error===null||error===void 0?void 0:(_error$response2=error.response)===null||_error$response2===void 0?void 0:(_error$response2$data=_error$response2.data)===null||_error$response2$data===void 0?void 0:_error$response2$data.error)!==null&&_ref3!==void 0?_ref3:'Unknown error';setSwapResult({ok:false,error:{code:'ERROR',message,details:error}});toast.error(\"Swap failed: \".concat(message));}finally{setLoading(false);await reloadBalances();}};const handleTokenSwap=()=>{swapSelectedTokens();setInputAmount('');setOutputAmount('');setQuote(null);};const renderTokenBadge=function(token,fallbackColor){var _token$symbol$charAt,_token$symbol;let fallbackTextColor=arguments.length>2&&arguments[2]!==undefined?arguments[2]:'text-gray-900 dark:text-gray-100';return/*#__PURE__*/_jsx(\"div\",{className:\"w-8 h-8 rounded-full overflow-hidden border border-white/40 shadow-inner flex items-center justify-center \".concat(token!==null&&token!==void 0&&token.logoUrl?'bg-white dark:bg-dark-700':fallbackColor),children:token!==null&&token!==void 0&&token.logoUrl?/*#__PURE__*/_jsx(\"img\",{src:token.logoUrl,alt:\"\".concat(token.symbol,\" logo\"),className:\"w-full h-full object-cover\",loading:\"lazy\"}):/*#__PURE__*/_jsx(\"span\",{className:\"text-xs font-bold uppercase \".concat(fallbackTextColor),children:(_token$symbol$charAt=token===null||token===void 0?void 0:(_token$symbol=token.symbol)===null||_token$symbol===void 0?void 0:_token$symbol.charAt(0))!==null&&_token$symbol$charAt!==void 0?_token$symbol$charAt:'?'})});};return/*#__PURE__*/_jsx(\"div\",{className:\"min-h-[calc(100vh-220px)] flex items-center justify-center px-4 py-10\",children:/*#__PURE__*/_jsxs(\"div\",{className:\"relative w-full max-w-md mx-auto\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"card-glow bg-white dark:bg-dark-900 relative overflow-hidden\",children:[/*#__PURE__*/_jsx(\"div\",{className:\"absolute inset-0 bg-mesh opacity-30\"}),/*#__PURE__*/_jsxs(\"div\",{className:\"relative flex items-center justify-between mb-6\",children:[/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsx(\"h2\",{className:\"heading-3\",children:\"Swap Tokens\"}),/*#__PURE__*/_jsx(\"p\",{className:\"body-small\",children:\"Trade tokens instantly with low fees\"})]}),/*#__PURE__*/_jsx(\"button\",{onClick:()=>setShowSettings(!showSettings),className:\"p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-dark-800 transition-colors\",title:\"Transaction Settings\",children:/*#__PURE__*/_jsxs(\"svg\",{className:\"w-5 h-5 text-gray-600 dark:text-gray-400\",fill:\"none\",stroke:\"currentColor\",viewBox:\"0 0 24 24\",children:[/*#__PURE__*/_jsx(\"path\",{strokeLinecap:\"round\",strokeLinejoin:\"round\",strokeWidth:2,d:\"M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z\"}),/*#__PURE__*/_jsx(\"path\",{strokeLinecap:\"round\",strokeLinejoin:\"round\",strokeWidth:2,d:\"M15 12a3 3 0 11-6 0 3 3 0 016 0z\"})]})})]}),showSettings&&/*#__PURE__*/_jsx(\"div\",{className:\"relative mb-4\",children:/*#__PURE__*/_jsx(SlippageSettings,{onClose:()=>setShowSettings(false)})}),/*#__PURE__*/_jsx(\"div\",{className:\"relative mb-2\",children:/*#__PURE__*/_jsxs(\"div\",{className:\"glass-subtle rounded-2xl p-4\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"flex items-center justify-between mb-3\",children:[/*#__PURE__*/_jsx(\"span\",{className:\"body-small\",children:\"From\"}),/*#__PURE__*/_jsxs(\"span\",{className:\"body-small\",children:[\"Balance: \",formatBalanceDisplay((_selectedTokens$from=selectedTokens.from)===null||_selectedTokens$from===void 0?void 0:_selectedTokens$from.symbol),balancesRefreshing&&/*#__PURE__*/_jsx(\"span\",{className:\"ml-2 text-xs text-gray-500\",children:\"Updating...\"})]})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"flex items-center space-x-3\",children:[/*#__PURE__*/_jsx(\"button\",{onClick:()=>setShowFromSelector(true),className:\"flex items-center space-x-2 px-3 py-2 rounded-xl bg-gray-100 dark:bg-dark-800 hover:bg-gray-200 dark:hover:bg-dark-700 transition-colors duration-200 min-w-fit whitespace-nowrap\",children:selectedTokens.from?/*#__PURE__*/_jsxs(_Fragment,{children:[renderTokenBadge(selectedTokens.from,'bg-primary-100 dark:bg-primary-900/20','text-primary-600 dark:text-primary-400'),/*#__PURE__*/_jsx(\"span\",{className:\"font-semibold text-gray-900 dark:text-gray-100\",children:selectedTokens.from.symbol})]}):/*#__PURE__*/_jsx(\"span\",{className:\"text-gray-500\",children:\"Select token\"})}),/*#__PURE__*/_jsx(\"input\",{type:\"text\",value:inputAmount,onChange:e=>setInputAmount(e.target.value),placeholder:\"0.0\",className:\"flex-1 max-w-[220px] text-right text-2xl font-semibold bg-transparent border-none outline-none text-gray-900 dark:text-gray-100 placeholder-gray-400\"})]})]})}),/*#__PURE__*/_jsx(\"div\",{className:\"flex justify-center -my-1 relative z-10\",children:/*#__PURE__*/_jsx(\"button\",{onClick:handleTokenSwap,className:\"p-2 rounded-xl bg-white dark:bg-dark-900 border-4 border-gray-50 dark:border-dark-950 shadow-lg hover:shadow-glow transition-all duration-200 hover:rotate-180 transform hover:scale-110\",children:/*#__PURE__*/_jsx(\"svg\",{className:\"w-5 h-5 text-gray-600 dark:text-gray-400\",fill:\"none\",stroke:\"currentColor\",viewBox:\"0 0 24 24\",children:/*#__PURE__*/_jsx(\"path\",{strokeLinecap:\"round\",strokeLinejoin:\"round\",strokeWidth:2,d:\"M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4\"})})})}),/*#__PURE__*/_jsx(\"div\",{className:\"relative mb-6\",children:/*#__PURE__*/_jsxs(\"div\",{className:\"glass-subtle rounded-2xl p-4\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"flex items-center justify-between mb-3\",children:[/*#__PURE__*/_jsx(\"span\",{className:\"body-small\",children:\"To\"}),/*#__PURE__*/_jsxs(\"span\",{className:\"body-small\",children:[\"Balance: \",formatBalanceDisplay((_selectedTokens$to=selectedTokens.to)===null||_selectedTokens$to===void 0?void 0:_selectedTokens$to.symbol),balancesRefreshing&&/*#__PURE__*/_jsx(\"span\",{className:\"ml-2 text-xs text-gray-500\",children:\"Updating...\"})]})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"flex items-center space-x-3\",children:[/*#__PURE__*/_jsx(\"button\",{onClick:()=>setShowToSelector(true),className:\"flex items-center space-x-2 px-3 py-2 rounded-xl bg-gray-100 dark:bg-dark-800 hover:bg-gray-200 dark:hover:bg-dark-700 transition-colors duration-200 min-w-fit whitespace-nowrap\",children:selectedTokens.to?/*#__PURE__*/_jsxs(_Fragment,{children:[renderTokenBadge(selectedTokens.to,'bg-success-100 dark:bg-success-900/20','text-success-600 dark:text-success-400'),/*#__PURE__*/_jsx(\"span\",{className:\"font-semibold text-gray-900 dark:text-gray-100\",children:selectedTokens.to.symbol})]}):/*#__PURE__*/_jsx(\"span\",{className:\"text-gray-500\",children:\"Select token\"})}),/*#__PURE__*/_jsx(\"div\",{className:\"flex-1 max-w-[220px] text-right text-2xl font-semibold text-gray-900 dark:text-gray-100\",children:calculating?'...':outputAmount||'0.0'})]})]})}),quote&&/*#__PURE__*/_jsxs(\"div\",{className:\"mb-6 glass-subtle rounded-xl p-4 space-y-2\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"flex justify-between body-small\",children:[/*#__PURE__*/_jsx(\"span\",{className:\"text-gray-600 dark:text-gray-400\",children:\"Rate:\"}),/*#__PURE__*/_jsxs(\"span\",{className:\"font-semibold text-gray-900 dark:text-gray-100\",children:[\"1 \",(_selectedTokens$from2=selectedTokens.from)===null||_selectedTokens$from2===void 0?void 0:_selectedTokens$from2.symbol,\" = \",(quote.outputAmount/quote.inputAmount).toFixed(4),\" \",(_selectedTokens$to2=selectedTokens.to)===null||_selectedTokens$to2===void 0?void 0:_selectedTokens$to2.symbol]})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"flex justify-between body-small\",children:[/*#__PURE__*/_jsx(\"span\",{className:\"text-gray-600 dark:text-gray-400\",children:\"Price Impact:\"}),/*#__PURE__*/_jsxs(\"span\",{className:\"font-semibold \".concat(quote.priceImpact>5?'text-error-600':'text-success-600'),children:[quote.priceImpact.toFixed(2),\"%\"]})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"flex justify-between body-small\",children:[/*#__PURE__*/_jsx(\"span\",{className:\"text-gray-600 dark:text-gray-400\",children:\"Fee:\"}),/*#__PURE__*/_jsxs(\"span\",{className:\"font-semibold text-gray-900 dark:text-gray-100\",children:[quote.fee.toFixed(6),\" \",(_selectedTokens$from3=selectedTokens.from)===null||_selectedTokens$from3===void 0?void 0:_selectedTokens$from3.symbol]})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"flex justify-between body-small\",children:[/*#__PURE__*/_jsx(\"span\",{className:\"text-gray-600 dark:text-gray-400\",children:\"Slippage Tolerance:\"}),/*#__PURE__*/_jsxs(\"span\",{className:\"font-semibold text-gray-900 dark:text-gray-100\",children:[slippage,\"%\"]})]})]}),/*#__PURE__*/_jsx(\"button\",{onClick:handleSwap,disabled:disableSwap,className:\"w-full py-4 rounded-xl font-semibold text-lg transition-all duration-200 flex items-center justify-center space-x-2 \".concat(disableSwap?'bg-gray-200 dark:bg-dark-800 text-gray-400 dark:text-gray-600 cursor-not-allowed':'btn-primary'),children:loading?/*#__PURE__*/_jsxs(_Fragment,{children:[/*#__PURE__*/_jsx(\"div\",{className:\"spinner w-5 h-5\"}),/*#__PURE__*/_jsx(\"span\",{children:\"Submitting...\"})]}):!partyId?'Connect Wallet':insufficientBalance?'Insufficient Balance':'Swap Tokens'}),(swapStatus||swapResult||ledgerRefreshStatus)&&/*#__PURE__*/_jsxs(\"div\",{className:\"mt-4 glass-subtle rounded-xl p-4 text-sm\",children:[swapStatus&&/*#__PURE__*/_jsx(\"div\",{className:\"font-semibold text-gray-900 dark:text-gray-100\",children:swapStatus}),ledgerRefreshStatus&&/*#__PURE__*/_jsx(\"div\",{className:\"text-gray-600 dark:text-gray-300\",children:ledgerRefreshStatus}),consumePayload&&/*#__PURE__*/_jsxs(\"div\",{className:\"mt-2 rounded-lg border border-gray-200 dark:border-dark-700 bg-white/70 dark:bg-dark-900/40 p-3\",children:[/*#__PURE__*/_jsx(\"div\",{className:\"text-xs font-semibold text-gray-800 dark:text-gray-200\",children:\"Payout\"}),/*#__PURE__*/_jsxs(\"div\",{className:\"mt-1 text-xs text-gray-700 dark:text-gray-300 space-y-1\",children:[/*#__PURE__*/_jsxs(\"div\",{children:[\"Status: \",payoutStatus||'UNKNOWN']}),payoutMessage&&/*#__PURE__*/_jsx(\"div\",{children:payoutMessage}),/*#__PURE__*/_jsxs(\"div\",{children:[\"Amount out: \",(_consumePayload$amoun=consumePayload===null||consumePayload===void 0?void 0:consumePayload.amountOut)!==null&&_consumePayload$amoun!==void 0?_consumePayload$amoun:'-']}),/*#__PURE__*/_jsxs(\"div\",{children:[\"Execute before: \",(_consumePayload$payou=consumePayload===null||consumePayload===void 0?void 0:consumePayload.payoutExecuteBefore)!==null&&_consumePayload$payou!==void 0?_consumePayload$payou:'-']}),/*#__PURE__*/_jsxs(\"div\",{children:[\"Payout CID: \",payoutCid||'none (completed)']})]})]}),swapResult&&/*#__PURE__*/_jsx(\"pre\",{className:\"mt-2 text-xs bg-gray-900 text-emerald-200 rounded-lg p-3 overflow-auto\",children:JSON.stringify(swapResult,null,2)})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"mt-6 grid grid-cols-3 gap-4\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"text-center\",children:[/*#__PURE__*/_jsx(\"div\",{className:\"text-success-500 mb-1\",children:/*#__PURE__*/_jsx(\"span\",{className:\"body-small font-medium\",children:\"24h Volume\"})}),/*#__PURE__*/_jsx(\"span\",{className:\"text-sm font-semibold text-gray-900 dark:text-gray-100\",children:formatCurrency(volume24h)})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"text-center\",children:[/*#__PURE__*/_jsx(\"div\",{className:\"text-primary-500 mb-1\",children:/*#__PURE__*/_jsx(\"span\",{className:\"body-small font-medium\",children:\"Avg Time\"})}),/*#__PURE__*/_jsx(\"span\",{className:\"text-sm font-semibold text-gray-900 dark:text-gray-100\",children:\"~2s\"})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"text-center\",children:[/*#__PURE__*/_jsx(\"div\",{className:\"text-warning-500 mb-1\",children:/*#__PURE__*/_jsx(\"span\",{className:\"body-small font-medium\",children:\"Fee\"})}),/*#__PURE__*/_jsx(\"span\",{className:\"text-sm font-semibold text-gray-900 dark:text-gray-100\",children:\"0.3%\"})]})]})]}),/*#__PURE__*/_jsx(TokenSelector,{isOpen:showFromSelector,onClose:()=>setShowFromSelector(false),balances:balancesBySymbol,onSelect:token=>{setSelectedTokens({from:token});setShowFromSelector(false);},tokens:tokens,selectedToken:selectedTokens.from,type:\"from\"}),/*#__PURE__*/_jsx(TokenSelector,{isOpen:showToSelector,onClose:()=>setShowToSelector(false),balances:balancesBySymbol,onSelect:token=>{setSelectedTokens({to:token});setShowToSelector(false);},tokens:tokens,selectedToken:selectedTokens.to,type:\"to\"})]})});};function instrumentIdToSymbol(instrumentId){const raw=instrumentId||'';const upper=raw.toUpperCase();if(upper==='AMULET')return'CC';return upper;}function resolveInstrumentForSymbol(symbol){if(!symbol)return null;const upper=symbol.toUpperCase();if(upper==='CC'||upper==='AMULET'){return{instrumentAdmin:AMULET_ADMIN,instrumentId:AMULET_ID};}if(upper==='CBTC'){return{instrumentAdmin:CBTC_ADMIN,instrumentId:CBTC_ID};}return null;}function resolvePoolInstruments(pool){var _pool$tokenA,_pool$tokenB;if(!pool)return null;const instA=resolveInstrumentForSymbol((_pool$tokenA=pool.tokenA)===null||_pool$tokenA===void 0?void 0:_pool$tokenA.symbol);const instB=resolveInstrumentForSymbol((_pool$tokenB=pool.tokenB)===null||_pool$tokenB===void 0?void 0:_pool$tokenB.symbol);if(!instA||!instB)return null;return{instrumentA:instA,instrumentB:instB};}function isDevnetSwapApiResponse(value){let expectedRequestId=arguments.length>1&&arguments[1]!==undefined?arguments[1]:'ping';return Boolean(value&&typeof value==='object'&&value.requestId===expectedRequestId&&typeof value.ok==='boolean');}function resolveSwapDirection(pool,fromSymbol,toSymbol){if(!pool)return null;const a=pool.tokenA.symbol.toUpperCase();const b=pool.tokenB.symbol.toUpperCase();const from=fromSymbol.toUpperCase();const to=toSymbol.toUpperCase();if(from===a&&to===b)return'A2B';if(from===b&&to===a)return'B2A';return null;}async function prepareLoopTransfer(provider,params){var _provider$auth_token,_provider$connection,_provider$sdk,_params$requestedAt;if(!provider){throw new Error('Loop provider is not connected');}const authToken=(_provider$auth_token=provider.auth_token)!==null&&_provider$auth_token!==void 0?_provider$auth_token:provider.authToken;const connection=(_provider$connection=provider.connection)!==null&&_provider$connection!==void 0?_provider$connection:provider===null||provider===void 0?void 0:(_provider$sdk=provider.sdk)===null||_provider$sdk===void 0?void 0:_provider$sdk.connection;const prepareTransfer=connection===null||connection===void 0?void 0:connection.prepareTransfer;if(!authToken||typeof prepareTransfer!=='function'){throw new Error('Loop provider does not expose transfer preparation');}const payload={recipient:params.recipient,amount:params.amount,instrument:{instrument_admin:params.instrument.instrumentAdmin,instrument_id:params.instrument.instrumentId},requested_at:(_params$requestedAt=params.requestedAt)!==null&&_params$requestedAt!==void 0?_params$requestedAt:new Date().toISOString(),execute_before:params.executeBefore,memo:params.memo};return prepareTransfer.call(connection,authToken,payload);}function extractPreparedCommands(prepared){var _ref5,_ref6,_ref7,_prepared$commands,_prepared$payload,_prepared$commandPayl,_prepared$command_pay;const commands=(_ref5=(_ref6=(_ref7=(_prepared$commands=prepared===null||prepared===void 0?void 0:prepared.commands)!==null&&_prepared$commands!==void 0?_prepared$commands:prepared===null||prepared===void 0?void 0:(_prepared$payload=prepared.payload)===null||_prepared$payload===void 0?void 0:_prepared$payload.commands)!==null&&_ref7!==void 0?_ref7:prepared===null||prepared===void 0?void 0:(_prepared$commandPayl=prepared.commandPayload)===null||_prepared$commandPayl===void 0?void 0:_prepared$commandPayl.commands)!==null&&_ref6!==void 0?_ref6:prepared===null||prepared===void 0?void 0:(_prepared$command_pay=prepared.command_payload)===null||_prepared$command_pay===void 0?void 0:_prepared$command_pay.commands)!==null&&_ref5!==void 0?_ref5:[];return Array.isArray(commands)?commands:[];}function extractPreparedTransferInstructionCid(prepared){var _ref8,_ref9,_ref0,_ref1,_ref10,_ref11,_prepared$transferIns,_prepared$payload2,_prepared$payload3,_prepared$payload4,_prepared$payload5;return(_ref8=(_ref9=(_ref0=(_ref1=(_ref10=(_ref11=(_prepared$transferIns=prepared===null||prepared===void 0?void 0:prepared.transferInstructionCid)!==null&&_prepared$transferIns!==void 0?_prepared$transferIns:prepared===null||prepared===void 0?void 0:prepared.transfer_instruction_cid)!==null&&_ref11!==void 0?_ref11:prepared===null||prepared===void 0?void 0:prepared.transferInstructionId)!==null&&_ref10!==void 0?_ref10:prepared===null||prepared===void 0?void 0:prepared.transfer_instruction_id)!==null&&_ref1!==void 0?_ref1:prepared===null||prepared===void 0?void 0:(_prepared$payload2=prepared.payload)===null||_prepared$payload2===void 0?void 0:_prepared$payload2.transferInstructionCid)!==null&&_ref0!==void 0?_ref0:prepared===null||prepared===void 0?void 0:(_prepared$payload3=prepared.payload)===null||_prepared$payload3===void 0?void 0:_prepared$payload3.transfer_instruction_cid)!==null&&_ref9!==void 0?_ref9:prepared===null||prepared===void 0?void 0:(_prepared$payload4=prepared.payload)===null||_prepared$payload4===void 0?void 0:_prepared$payload4.transferInstructionId)!==null&&_ref8!==void 0?_ref8:prepared===null||prepared===void 0?void 0:(_prepared$payload5=prepared.payload)===null||_prepared$payload5===void 0?void 0:_prepared$payload5.transfer_instruction_id;}function extractExerciseContractId(commands){for(const command of commands){var _ref12,_command$ExerciseComm,_exercise$contractId;const exercise=(_ref12=(_command$ExerciseComm=command===null||command===void 0?void 0:command.ExerciseCommand)!==null&&_command$ExerciseComm!==void 0?_command$ExerciseComm:command===null||command===void 0?void 0:command.exerciseCommand)!==null&&_ref12!==void 0?_ref12:command===null||command===void 0?void 0:command.exercise_command;const contractId=(_exercise$contractId=exercise===null||exercise===void 0?void 0:exercise.contractId)!==null&&_exercise$contractId!==void 0?_exercise$contractId:exercise===null||exercise===void 0?void 0:exercise.contract_id;if(contractId){return contractId;}}return undefined;}function extractPreparedDisclosedContracts(prepared){var _ref13,_ref14,_ref15,_prepared$disclosedCo,_prepared$extraArgs,_prepared$extra_args;const disclosed=(_ref13=(_ref14=(_ref15=(_prepared$disclosedCo=prepared===null||prepared===void 0?void 0:prepared.disclosedContracts)!==null&&_prepared$disclosedCo!==void 0?_prepared$disclosedCo:prepared===null||prepared===void 0?void 0:prepared.disclosed_contracts)!==null&&_ref15!==void 0?_ref15:prepared===null||prepared===void 0?void 0:(_prepared$extraArgs=prepared.extraArgs)===null||_prepared$extraArgs===void 0?void 0:_prepared$extraArgs.disclosedContracts)!==null&&_ref14!==void 0?_ref14:prepared===null||prepared===void 0?void 0:(_prepared$extra_args=prepared.extra_args)===null||_prepared$extra_args===void 0?void 0:_prepared$extra_args.disclosed_contracts)!==null&&_ref13!==void 0?_ref13:[];return Array.isArray(disclosed)&&disclosed.length>0?disclosed:undefined;}function extractPreparedPackagePreference(prepared){var _ref16,_ref17,_ref18,_prepared$packageIdSe;const pref=(_ref16=(_ref17=(_ref18=(_prepared$packageIdSe=prepared===null||prepared===void 0?void 0:prepared.packageIdSelectionPreference)!==null&&_prepared$packageIdSe!==void 0?_prepared$packageIdSe:prepared===null||prepared===void 0?void 0:prepared.package_id_selection_preference)!==null&&_ref18!==void 0?_ref18:prepared===null||prepared===void 0?void 0:prepared.packageIdSelection)!==null&&_ref17!==void 0?_ref17:prepared===null||prepared===void 0?void 0:prepared.package_id_selection)!==null&&_ref16!==void 0?_ref16:undefined;return Array.isArray(pref)&&pref.length>0?pref:undefined;}function extractPreparedSynchronizerId(prepared){var _ref19,_prepared$synchronize;return(_ref19=(_prepared$synchronize=prepared===null||prepared===void 0?void 0:prepared.synchronizerId)!==null&&_prepared$synchronize!==void 0?_prepared$synchronize:prepared===null||prepared===void 0?void 0:prepared.synchronizer_id)!==null&&_ref19!==void 0?_ref19:undefined;}function extractPreparedActAs(prepared,fallback){var _ref20,_ref21,_prepared$actAs;const actAs=(_ref20=(_ref21=(_prepared$actAs=prepared===null||prepared===void 0?void 0:prepared.actAs)!==null&&_prepared$actAs!==void 0?_prepared$actAs:prepared===null||prepared===void 0?void 0:prepared.act_as)!==null&&_ref21!==void 0?_ref21:prepared===null||prepared===void 0?void 0:prepared.actAsParties)!==null&&_ref20!==void 0?_ref20:prepared===null||prepared===void 0?void 0:prepared.act_as_parties;return actAs||fallback;}function extractPreparedReadAs(prepared,fallback){var _ref22,_ref23,_prepared$readAs;const readAs=(_ref22=(_ref23=(_prepared$readAs=prepared===null||prepared===void 0?void 0:prepared.readAs)!==null&&_prepared$readAs!==void 0?_prepared$readAs:prepared===null||prepared===void 0?void 0:prepared.read_as)!==null&&_ref23!==void 0?_ref23:prepared===null||prepared===void 0?void 0:prepared.readAsParties)!==null&&_ref22!==void 0?_ref22:prepared===null||prepared===void 0?void 0:prepared.read_as_parties;return readAs||fallback;}function decimalAddStrings(a,b){const sa=a!==null&&a!==void 0?a:'0';const sb=b!==null&&b!==void 0?b:'0';const[ia,fa='']=sa.split('.');const[ib,fb='']=sb.split('.');const fracLen=Math.max(fa.length,fb.length);const normFa=(fa+'0'.repeat(fracLen)).slice(0,fracLen);const normFb=(fb+'0'.repeat(fracLen)).slice(0,fracLen);const intA=BigInt(ia||'0');const intB=BigInt(ib||'0');const fracA=BigInt(normFa||'0');const fracB=BigInt(normFb||'0');const fracSum=fracA+fracB;const baseStr='1'+'0'.repeat(fracLen||0);const base=BigInt(baseStr);const carry=fracSum/base;const fracRes=fracSum%base;const intRes=intA+intB+carry;const fracStr=fracLen>0?fracRes.toString().padStart(fracLen,'0').replace(/0+$/,''):'';return fracStr.length>0?\"\".concat(intRes.toString(),\".\").concat(fracStr):intRes.toString();}export default SwapInterface;","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}