{"ast":null,"code":"import React,{useCallback,useEffect,useMemo,useState}from'react';import{RefreshCw,X,Clock,CheckCircle2,Loader2,Copy,AlertTriangle}from'lucide-react';import toast from'react-hot-toast';import{backendApi}from'../services/backendApi';import{jsx as _jsx,jsxs as _jsxs}from\"react/jsx-runtime\";const numberFormatter=new Intl.NumberFormat('en',{notation:'compact',compactDisplay:'short',maximumFractionDigits:2});const addThousandsSeparator=digits=>digits.replace(/\\B(?=(\\d{3})+(?!\\d))/g,',');const formatFullAmount=value=>{if(!value)return'—';const trimmed=value.trim();if(!/^-?\\d+(\\.\\d+)?$/.test(trimmed)){return trimmed;}const negative=trimmed.startsWith('-');const unsigned=negative?trimmed.slice(1):trimmed;const[rawInt='0',rawFrac]=unsigned.split('.');const intDigits=rawInt.replace(/^0+(?=\\d)/,'')||'0';const formattedInt=addThousandsSeparator(intDigits);if(!rawFrac){return negative?\"-\".concat(formattedInt):formattedInt;}const trimmedFrac=rawFrac.replace(/0+$/,'');const body=trimmedFrac.length?\"\".concat(formattedInt,\".\").concat(trimmedFrac):formattedInt;return negative?\"-\".concat(body):body;};const dateTimeFormatter=new Intl.DateTimeFormat('en-US',{month:'short',day:'numeric',year:'numeric',hour:'numeric',minute:'2-digit'});// Keep compact formatter available if needed later; suppress unused lint for now.\n// eslint-disable-next-line @typescript-eslint/no-unused-vars\nconst formatCompact=value=>{if(!value)return'—';const num=Number(value);if(!Number.isFinite(num))return value;return numberFormatter.format(num);};const formatDateTime=iso=>{if(!iso)return'—';try{return dateTimeFormatter.format(new Date(iso));}catch(_unused){return iso;}};const buildPairKey=(a,b)=>{var _a$toUpperCase,_a$toUpperCase2,_b$toUpperCase,_b$toUpperCase2;return[(_a$toUpperCase=a===null||a===void 0?void 0:(_a$toUpperCase2=a.toUpperCase)===null||_a$toUpperCase2===void 0?void 0:_a$toUpperCase2.call(a))!==null&&_a$toUpperCase!==void 0?_a$toUpperCase:'',(_b$toUpperCase=b===null||b===void 0?void 0:(_b$toUpperCase2=b.toUpperCase)===null||_b$toUpperCase2===void 0?void 0:_b$toUpperCase2.call(b))!==null&&_b$toUpperCase!==void 0?_b$toUpperCase:''].sort().join('/');};const trimNumberString=function(value){let precision=arguments.length>1&&arguments[1]!==undefined?arguments[1]:10;if(!Number.isFinite(value)){return null;}const fixed=value.toFixed(precision);const trimmed=fixed.replace(/0+$/,'').replace(/\\.$/,'');return trimmed.length>0?trimmed:'0';};const formatRelativeTime=iso=>{if(!iso)return'—';const created=new Date(iso).getTime();if(Number.isNaN(created))return iso;const diffMs=Date.now()-created;if(diffMs<60000)return'Just now';const minutes=Math.floor(diffMs/60000);if(minutes<60)return\"\".concat(minutes,\" min ago\");const hours=Math.floor(minutes/60);if(hours<24)return\"\".concat(hours,\"h ago\");const days=Math.floor(hours/24);return\"\".concat(days,\"d ago\");};const statusStyles={settled:'bg-success-500/10 text-success-600 dark:text-success-400 border-success-500/30',pending:'bg-warning-500/10 text-warning-600 dark:text-warning-400 border-warning-500/30',failed:'bg-error-500/10 text-error-600 dark:text-error-400 border-error-500/30'};const statusLabels={settled:'Settled',pending:'Pending',failed:'Failed'};const timelineIcon=status=>{switch(status){case'completed':return/*#__PURE__*/_jsx(CheckCircle2,{className:\"h-5 w-5 text-success-500\"});case'pending':return/*#__PURE__*/_jsx(Clock,{className:\"h-5 w-5 text-warning-500\"});case'failed':return/*#__PURE__*/_jsx(AlertTriangle,{className:\"h-5 w-5 text-error-500\"});default:return/*#__PURE__*/_jsx(Clock,{className:\"h-5 w-5 text-gray-400\"});}};const TransactionHistory=()=>{const[transactions,setTransactions]=useState([]);const[loading,setLoading]=useState(true);const[refreshing,setRefreshing]=useState(false);const[error,setError]=useState(null);const[dismissedIds,setDismissedIds]=useState(new Set());const[selectedId,setSelectedId]=useState(null);const[pools,setPools]=useState([]);const fetchHistory=useCallback(async()=>{try{setError(null);const entries=await backendApi.getTransactionHistory();setTransactions(entries);}catch(err){console.error('Failed to load transaction history:',err);setError('Impossible de charger l’historique. Réessayez dans un instant.');}finally{setLoading(false);setRefreshing(false);}},[]);useEffect(()=>{fetchHistory();},[fetchHistory]);useEffect(()=>{let mounted=true;backendApi.getPools().then(data=>{if(mounted){setPools(data);}}).catch(err=>{console.warn('Failed to load pools for history view',err);});return()=>{mounted=false;};},[]);useEffect(()=>{if(typeof window==='undefined'){return;}const handler=()=>fetchHistory();window.addEventListener('clearportx:transactions:refresh',handler);return()=>window.removeEventListener('clearportx:transactions:refresh',handler);},[fetchHistory]);const visibleTransactions=useMemo(()=>transactions.filter(tx=>!dismissedIds.has(tx.id)),[transactions,dismissedIds]);useEffect(()=>{if(!selectedId&&visibleTransactions.length>0){setSelectedId(visibleTransactions[0].id);}else if(selectedId&&!visibleTransactions.find(tx=>tx.id===selectedId)){var _visibleTransactions$;setSelectedId(((_visibleTransactions$=visibleTransactions[0])===null||_visibleTransactions$===void 0?void 0:_visibleTransactions$.id)||null);}},[visibleTransactions,selectedId]);const selectedTransaction=useMemo(()=>visibleTransactions.find(tx=>tx.id===selectedId)||null,[visibleTransactions,selectedId]);const handleRefresh=async()=>{setRefreshing(true);await fetchHistory();};const handleDismiss=id=>{setDismissedIds(prev=>{const next=new Set(prev);next.add(id);return next;});};const handleCopyContractId=async contractId=>{try{await navigator.clipboard.writeText(contractId);toast.success('Contract ID copied to clipboard');}catch(_unused2){toast.error('Unable to copy Contract ID');}};const formatTypeLabel=type=>{switch(type){case'ADD_LIQUIDITY':return'Add Liquidity';case'SWAP':return'Swap';case'POOL_CREATION':return'Pool Creation';default:return type.replace('_',' ');}};const poolLookup=useMemo(()=>{const map=new Map();pools.forEach(pool=>{if(pool.poolId){map.set(pool.poolId,pool);}map.set(buildPairKey(pool.tokenA.symbol,pool.tokenB.symbol),pool);});return map;},[pools]);const estimateSwapOutput=useCallback(tx=>{var _pool$feeRate;if(tx.type!=='SWAP'){return null;}const amountIn=Number(tx.amountADesired);if(!Number.isFinite(amountIn)||amountIn<=0){return null;}const pool=tx.poolId&&poolLookup.get(tx.poolId)||poolLookup.get(buildPairKey(tx.tokenA,tx.tokenB));if(!pool){return null;}const isAtoB=tx.tokenA===pool.tokenA.symbol&&tx.tokenB===pool.tokenB.symbol;const isBtoA=tx.tokenA===pool.tokenB.symbol&&tx.tokenB===pool.tokenA.symbol;if(!isAtoB&&!isBtoA){return null;}const reserveIn=isAtoB?pool.reserveA:pool.reserveB;const reserveOut=isAtoB?pool.reserveB:pool.reserveA;if(!Number.isFinite(reserveIn)||!Number.isFinite(reserveOut)||reserveIn<=0||reserveOut<=0){return null;}const feeRate=(_pool$feeRate=pool.feeRate)!==null&&_pool$feeRate!==void 0?_pool$feeRate:0.003;const inputAfterFee=amountIn*(1-feeRate);if(inputAfterFee<=0){return null;}const outputAmount=inputAfterFee*reserveOut/(reserveIn+inputAfterFee);return Number.isFinite(outputAmount)&&outputAmount>0?outputAmount:null;},[poolLookup]);const formatSwapOutput=useCallback(tx=>{const estimated=estimateSwapOutput(tx);if(estimated!=null){const trimmed=trimNumberString(estimated);if(trimmed){return formatFullAmount(trimmed);}}return formatFullAmount(tx.amountBDesired);},[estimateSwapOutput]);const summarizeAmount=tx=>{if(tx.type==='SWAP'){return\"\".concat(formatFullAmount(tx.amountADesired),\" \").concat(tx.tokenA,\" \\u2192 \").concat(formatSwapOutput(tx),\" \").concat(tx.tokenB);}return\"\".concat(formatFullAmount(tx.amountADesired),\" \").concat(tx.tokenA,\" / \").concat(formatFullAmount(tx.amountBDesired),\" \").concat(tx.tokenB);};const renderDetails=tx=>[{label:'Token A',value:tx.tokenA||'—'},{label:'Amount A Desired',value:\"\".concat(formatFullAmount(tx.amountADesired),\" \").concat(tx.tokenA)},{label:'Token B',value:tx.tokenB||'—'},{label:'Amount B Desired',value:\"\".concat(tx.type==='SWAP'?formatSwapOutput(tx):formatFullAmount(tx.amountBDesired),\" \").concat(tx.tokenB)},{label:'Min LP Amount',value:tx.minLpAmount?\"\".concat(formatFullAmount(tx.minLpAmount),\" \").concat(tx.lpTokenSymbol||'LP'):'—'},{label:'LP Tokens Minted',value:tx.lpMintedAmount?\"\".concat(formatFullAmount(tx.lpMintedAmount),\" \").concat(tx.lpTokenSymbol||'LP'):'—'},{label:'Expires At',value:formatDateTime(tx.expiresAt)},{label:'Status',value:statusLabels[tx.status]}];if(loading){return/*#__PURE__*/_jsx(\"div\",{className:\"max-w-5xl mx-auto\",children:/*#__PURE__*/_jsxs(\"div\",{className:\"card\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"flex items-center justify-between mb-8\",children:[/*#__PURE__*/_jsx(\"h2\",{className:\"heading-2\",children:\"Transaction History\"}),/*#__PURE__*/_jsx(\"div\",{className:\"h-10 w-10 rounded-full border border-gray-200 dark:border-gray-700 flex items-center justify-center\",children:/*#__PURE__*/_jsx(Loader2,{className:\"h-5 w-5 animate-spin text-accent-600\"})})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"space-y-4\",children:[/*#__PURE__*/_jsx(\"div\",{className:\"h-5 bg-gray-200/60 dark:bg-dark-800/60 rounded-lg animate-pulse\"}),/*#__PURE__*/_jsx(\"div\",{className:\"h-40 bg-gray-200/30 dark:bg-dark-800/30 rounded-2xl animate-pulse\"})]})]})});}return/*#__PURE__*/_jsx(\"div\",{className:\"max-w-5xl mx-auto space-y-8\",children:/*#__PURE__*/_jsxs(\"div\",{className:\"card\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between mb-6\",children:[/*#__PURE__*/_jsx(\"div\",{children:/*#__PURE__*/_jsx(\"h2\",{className:\"heading-2\",children:\"Transaction History\"})}),/*#__PURE__*/_jsxs(\"button\",{onClick:handleRefresh,disabled:refreshing,className:\"btn-secondary flex items-center justify-center gap-2 px-4 py-2\",children:[/*#__PURE__*/_jsx(RefreshCw,{className:\"h-4 w-4 \".concat(refreshing?'animate-spin':'')}),\"Actualiser\"]})]}),error&&/*#__PURE__*/_jsx(\"div\",{className:\"mb-6 rounded-xl border border-warning-500/40 bg-warning-500/10 px-4 py-3 text-warning-700 dark:text-warning-100\",children:error}),visibleTransactions.length===0?/*#__PURE__*/_jsxs(\"div\",{className:\"text-center py-20\",children:[/*#__PURE__*/_jsx(\"p\",{className:\"text-gray-500 dark:text-gray-400 mb-2\",children:\"Aucune transaction disponible pour le moment.\"}),/*#__PURE__*/_jsx(\"p\",{className:\"text-sm text-gray-400\",children:\"Ex\\xE9cutez un swap ou un ajout de liquidit\\xE9 pour voir l'historique.\"})]}):/*#__PURE__*/_jsxs(\"div\",{className:\"space-y-8\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"overflow-hidden rounded-2xl border border-gray-200/60 dark:border-gray-800/60 bg-white/70 dark:bg-dark-900/70\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"grid grid-cols-4 gap-4 px-4 py-3 text-xs font-semibold uppercase tracking-wide text-gray-500 dark:text-gray-400\",children:[/*#__PURE__*/_jsx(\"span\",{children:\"Time\"}),/*#__PURE__*/_jsx(\"span\",{children:\"Type\"}),/*#__PURE__*/_jsx(\"span\",{children:\"Amount\"}),/*#__PURE__*/_jsx(\"span\",{children:\"Status\"})]}),/*#__PURE__*/_jsx(\"div\",{className:\"divide-y divide-gray-200/60 dark:divide-gray-800/60\",children:visibleTransactions.map(tx=>/*#__PURE__*/_jsx(\"button\",{onClick:()=>setSelectedId(tx.id),className:\"w-full text-left px-4 py-3 transition duration-200 \".concat(selectedId===tx.id?'bg-white dark:bg-dark-800':'hover:bg-gray-50 dark:hover:bg-dark-800/40'),children:/*#__PURE__*/_jsxs(\"div\",{className:\"grid grid-cols-4 gap-4 items-center\",children:[/*#__PURE__*/_jsx(\"span\",{className:\"text-sm text-gray-600 dark:text-gray-300\",children:formatRelativeTime(tx.createdAt)}),/*#__PURE__*/_jsx(\"span\",{className:\"text-sm font-medium text-gray-900 dark:text-gray-100\",children:formatTypeLabel(tx.type)}),/*#__PURE__*/_jsx(\"span\",{className:\"text-sm text-gray-700 dark:text-gray-200\",children:summarizeAmount(tx)}),/*#__PURE__*/_jsx(\"span\",{className:\"justify-self-start px-3 py-1 rounded-full text-xs font-semibold border \".concat(statusStyles[tx.status]),children:statusLabels[tx.status]})]})},tx.id))})]}),selectedTransaction&&/*#__PURE__*/_jsxs(\"article\",{className:\"rounded-2xl border border-gray-200/60 dark:border-gray-800/60 bg-white/80 dark:bg-dark-900/80 p-6 shadow-lg\",children:[/*#__PURE__*/_jsxs(\"header\",{className:\"flex flex-col gap-4 md:flex-row md:items-start md:justify-between border-b border-gray-200/60 dark:border-gray-800/60 pb-5 mb-6\",children:[/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsx(\"p\",{className:\"text-sm text-accent-600 font-semibold uppercase tracking-wide\",children:selectedTransaction.title}),/*#__PURE__*/_jsxs(\"h3\",{className:\"text-responsive-lg font-semibold mt-1 text-gray-900 dark:text-gray-100\",children:[selectedTransaction.tokenA,\"/\",selectedTransaction.tokenB]}),/*#__PURE__*/_jsxs(\"p\",{className:\"text-sm text-gray-500 dark:text-gray-400\",children:[\"Created \",formatDateTime(selectedTransaction.createdAt)]})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"flex items-center gap-3\",children:[/*#__PURE__*/_jsx(\"span\",{className:\"px-4 py-1.5 rounded-full text-sm font-medium border \".concat(statusStyles[selectedTransaction.status]),children:statusLabels[selectedTransaction.status]}),/*#__PURE__*/_jsx(\"button\",{onClick:()=>handleDismiss(selectedTransaction.id),className:\"h-10 w-10 rounded-full border border-gray-200 dark:border-gray-700 flex items-center justify-center hover:bg-gray-50 dark:hover:bg-dark-800 transition-colors\",title:\"Fermer cette fiche\",children:/*#__PURE__*/_jsx(X,{className:\"h-4 w-4\"})})]})]}),/*#__PURE__*/_jsxs(\"section\",{className:\"mb-8\",children:[/*#__PURE__*/_jsx(\"h4\",{className:\"text-lg font-semibold text-gray-900 dark:text-gray-100 mb-4\",children:\"Transaction Details\"}),/*#__PURE__*/_jsx(\"div\",{className:\"grid grid-cols-1 md:grid-cols-2 gap-4\",children:renderDetails(selectedTransaction).map(detail=>/*#__PURE__*/_jsxs(\"div\",{className:\"rounded-xl border border-gray-100 dark:border-gray-800 bg-white/60 dark:bg-dark-900/60 p-4\",children:[/*#__PURE__*/_jsx(\"p\",{className:\"text-sm text-gray-500 dark:text-gray-400\",children:detail.label}),/*#__PURE__*/_jsx(\"p\",{className:\"text-lg font-semibold text-gray-900 dark:text-gray-100\",children:detail.value})]},\"\".concat(selectedTransaction.id,\"-\").concat(detail.label)))})]}),/*#__PURE__*/_jsxs(\"section\",{className:\"mb-8\",children:[/*#__PURE__*/_jsx(\"h4\",{className:\"text-lg font-semibold text-gray-900 dark:text-gray-100 mb-4\",children:\"Event Timeline\"}),/*#__PURE__*/_jsx(\"ol\",{className:\"relative border-l border-gray-200 dark:border-gray-700 pl-6 space-y-6\",children:selectedTransaction.eventTimeline.map(event=>/*#__PURE__*/_jsxs(\"li\",{className:\"relative\",children:[/*#__PURE__*/_jsx(\"span\",{className:\"absolute -left-3 top-0 inline-flex h-6 w-6 items-center justify-center rounded-full bg-white dark:bg-dark-900 border border-gray-200 dark:border-gray-700 shadow\",children:timelineIcon(event.status)}),/*#__PURE__*/_jsxs(\"div\",{className:\"rounded-xl border border-gray-100 dark:border-gray-800 bg-white/80 dark:bg-dark-900/70 p-4\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"flex items-center justify-between mb-1\",children:[/*#__PURE__*/_jsx(\"p\",{className:\"font-semibold text-gray-900 dark:text-gray-100\",children:event.title}),event.timestamp&&/*#__PURE__*/_jsx(\"span\",{className:\"text-xs text-gray-500 dark:text-gray-400\",children:formatDateTime(event.timestamp)})]}),/*#__PURE__*/_jsx(\"p\",{className:\"text-sm text-gray-600 dark:text-gray-300\",children:event.description})]})]},event.id))})]}),/*#__PURE__*/_jsxs(\"section\",{children:[/*#__PURE__*/_jsx(\"h4\",{className:\"text-lg font-semibold text-gray-900 dark:text-gray-100 mb-3\",children:\"Contract ID\"}),/*#__PURE__*/_jsxs(\"div\",{className:\"flex flex-col md:flex-row md:items-center gap-4\",children:[/*#__PURE__*/_jsx(\"code\",{className:\"flex-1 text-xs md:text-sm break-all rounded-xl bg-gray-900/90 text-white px-4 py-3 shadow-inner\",children:selectedTransaction.contractId||'N/A'}),/*#__PURE__*/_jsxs(\"button\",{onClick:()=>handleCopyContractId(selectedTransaction.contractId),className:\"btn-secondary flex items-center justify-center gap-2 px-4 py-2\",children:[/*#__PURE__*/_jsx(Copy,{className:\"h-4 w-4\"}),\"Copier\"]})]})]})]})]})]})});};export default TransactionHistory;","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}