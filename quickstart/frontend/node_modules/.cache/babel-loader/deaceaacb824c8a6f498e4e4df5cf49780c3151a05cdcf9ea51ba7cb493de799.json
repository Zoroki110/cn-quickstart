{"ast":null,"code":"import{zoro,SignRequestResponseType}from\"../vendor/zoro-sdk\";const DEBUG=typeof window!==\"undefined\"&&localStorage.getItem(\"clearportx.debug.zoro\")===\"1\";const CONNECT_TIMEOUT_MS=45000;let initDone=false;let activeConnector=null;export class ZoroWalletConnector{constructor(){this.wallet=null;this.connectPromise=null;this.pendingResolve=null;this.pendingReject=null;this.pendingTimer=null;}static ensureInitOnce(){if(initDone)return;const network=process.env.REACT_APP_ZORO_NETWORK||\"mainnet\";const walletUrl=process.env.REACT_APP_ZORO_WALLET_URL||undefined;const apiUrl=process.env.REACT_APP_ZORO_API_URL||undefined;const iconUrl=process.env.REACT_APP_ZORO_ICON_URL||(typeof window!==\"undefined\"?window.location.origin:undefined);const appName=process.env.REACT_APP_ZORO_APP_NAME||\"ClearportX\";if(DEBUG)console.debug(\"[Zoro] init start\",{network,walletUrl,apiUrl,iconUrl,appName});zoro.init({appName,iconUrl,network:network,walletUrl,apiUrl,onAccept:wallet=>{var _activeConnector;(_activeConnector=activeConnector)===null||_activeConnector===void 0?void 0:_activeConnector.handleAccept(wallet);},onReject:()=>{var _activeConnector2;(_activeConnector2=activeConnector)===null||_activeConnector2===void 0?void 0:_activeConnector2.handleReject(new Error(\"Zoro connection rejected\"));},onDisconnect:()=>{var _activeConnector3;(_activeConnector3=activeConnector)===null||_activeConnector3===void 0?void 0:_activeConnector3.handleDisconnect();}});if(DEBUG)console.debug(\"[Zoro] init done\");initDone=true;}connectFromClick(){activeConnector=this;ZoroWalletConnector.ensureInitOnce();if(DEBUG)console.debug(\"[Zoro] connect called\");this.ensureConnectPromise();return this.connectPromise;}async connect(){activeConnector=this;ZoroWalletConnector.ensureInitOnce();if(this.wallet)return;if(this.connectPromise){await this.connectPromise;return;}this.ensureConnectPromise();await this.connectPromise;}async getParty(){var _this$wallet$partyId,_this$wallet,_this$wallet2;await this.ensureConnected();const party=(_this$wallet$partyId=(_this$wallet=this.wallet)===null||_this$wallet===void 0?void 0:_this$wallet.partyId)!==null&&_this$wallet$partyId!==void 0?_this$wallet$partyId:typeof((_this$wallet2=this.wallet)===null||_this$wallet2===void 0?void 0:_this$wallet2.getPartyId)===\"function\"?await this.wallet.getPartyId():null;if(!party){throw new Error(\"Zoro connect succeeded but partyId is missing. Allow popups and retry.\");}return party;}getType(){return\"zoro\";}getProvider(){return this.wallet;}async signMessage(message){await this.ensureConnected();if(!this.wallet||typeof this.wallet.signMessage!==\"function\"){throw new Error(\"Zoro wallet does not expose signMessage()\");}return new Promise((resolve,reject)=>{try{var _this$wallet3,_this$wallet3$signMes;(_this$wallet3=this.wallet)===null||_this$wallet3===void 0?void 0:(_this$wallet3$signMes=_this$wallet3.signMessage)===null||_this$wallet3$signMes===void 0?void 0:_this$wallet3$signMes.call(_this$wallet3,message,response=>{const type=response===null||response===void 0?void 0:response.type;if(type===SignRequestResponseType.SIGN_REQUEST_APPROVED){var _response$data;const sig=response===null||response===void 0?void 0:(_response$data=response.data)===null||_response$data===void 0?void 0:_response$data.signature;if(typeof sig===\"string\"){if(DEBUG)console.debug(\"[Zoro] signMessage approved\");resolve(sig);return;}reject(new Error(\"Zoro signature missing or not a string\"));return;}if(type===SignRequestResponseType.SIGN_REQUEST_REJECTED){var _response$data2;if(DEBUG)console.debug(\"[Zoro] signMessage rejected\");reject(new Error((response===null||response===void 0?void 0:(_response$data2=response.data)===null||_response$data2===void 0?void 0:_response$data2.reason)||\"Signature rejected\"));return;}if(type===SignRequestResponseType.SIGN_REQUEST_ERROR){var _response$data3;if(DEBUG)console.debug(\"[Zoro] signMessage error\");reject(new Error((response===null||response===void 0?void 0:(_response$data3=response.data)===null||_response$data3===void 0?void 0:_response$data3.error)||\"Signature error\"));return;}reject(new Error(\"Unknown Zoro signMessage response\"));});}catch(err){reject(err);}});}async getHoldings(){var _this$wallet4;await this.ensureConnected();const getter=(_this$wallet4=this.wallet)===null||_this$wallet4===void 0?void 0:_this$wallet4.getHoldingUtxos;if(typeof getter!==\"function\"){throw new Error(\"Zoro wallet does not expose getHoldingUtxos()\");}const res=await getter.call(this.wallet);if(DEBUG)console.debug(\"[Zoro] getHoldingUtxos len=\",Array.isArray(res)?res.length:\"n/a\");return res;}async disconnect(){await this.cleanup();}ensureConnectPromise(){if(this.wallet||this.connectPromise)return;this.connectPromise=new Promise((resolve,reject)=>{this.pendingResolve=resolve;this.pendingReject=reject;this.pendingTimer=setTimeout(()=>{if(DEBUG)console.debug(\"[Zoro] connect timeout\");this.clearPending();void this.cleanup();reject(new Error(\"Zoro connect timeout. Allow popups for this site.\"));},CONNECT_TIMEOUT_MS);try{zoro.connect();}catch(err){this.clearPending();void this.cleanup();reject(err);}});}async ensureConnected(){if(this.wallet)return;await this.connect();if(!this.wallet){throw new Error(\"Zoro wallet did not provide a provider after connect()\");}}async handleAccept(wallet){this.wallet=wallet;if(DEBUG)console.debug(\"[Zoro] onAccept wallet keys:\",Object.keys(wallet||{}));if(this.pendingResolve)this.pendingResolve();this.clearPending();}async handleReject(err){if(DEBUG)console.debug(\"[Zoro] onReject\");if(this.pendingReject){this.pendingReject(err);}await this.cleanup();this.clearPending();}async handleDisconnect(){if(DEBUG)console.debug(\"[Zoro] onDisconnect\");await this.cleanup();this.clearPending();}async cleanup(){this.wallet=null;this.clearPending();try{if(typeof window!==\"undefined\"){window.localStorage.removeItem(\"zoro_connect\");}}catch(_unused){// ignore storage errors\n}try{await zoro.disconnect();}catch(_unused2){// ignore\n}}clearPending(){if(this.pendingTimer){clearTimeout(this.pendingTimer);}this.pendingTimer=null;this.pendingResolve=null;this.pendingReject=null;this.connectPromise=null;}}","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}