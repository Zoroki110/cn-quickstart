{"ast":null,"code":"import _objectSpread from\"/root/cn-quickstart/quickstart/frontend/node_modules/@babel/runtime/helpers/esm/objectSpread2.js\";import{getLoopProvider}from\"./loopProvider\";const DEFAULT_APP_ID=\"clearportx\";const MEMO_KEY=\"splice.lfdecentralizedtrust.org/reason\";function resolveMode(mode){var _process$env$REACT_AP;const forced=((_process$env$REACT_AP=process.env.REACT_APP_LOOP_SUBMIT_MODE)!==null&&_process$env$REACT_AP!==void 0?_process$env$REACT_AP:\"\").toUpperCase();if(forced===\"WAIT\"||forced===\"LEGACY\"){return forced;}return mode!==null&&mode!==void 0?mode:\"WAIT\";}function legacyEnabled(){var _process$env$REACT_AP2;return((_process$env$REACT_AP2=process.env.REACT_APP_LOOP_SUBMIT_LEGACY)!==null&&_process$env$REACT_AP2!==void 0?_process$env$REACT_AP2:\"true\")!==\"false\";}function normalizePartyList(value){if(!value)return undefined;return Array.isArray(value)?value:[value];}function applyMemoToArgument(arg,memo){if(!memo||!arg||typeof arg!==\"object\")return arg;const next=_objectSpread({},arg);if(next.meta&&typeof next.meta===\"object\"){var _next$meta$values;next.meta=_objectSpread(_objectSpread({},next.meta),{},{values:_objectSpread(_objectSpread({},(_next$meta$values=next.meta.values)!==null&&_next$meta$values!==void 0?_next$meta$values:{}),{},{[MEMO_KEY]:memo})});return next;}if(next.transfer&&typeof next.transfer===\"object\"){next.transfer=applyMemoToArgument(next.transfer,memo);return next;}return next;}function applyMemoToCommands(commands,memo){if(!memo)return commands;let cloned=commands;try{cloned=JSON.parse(JSON.stringify(commands));}catch(_unused){cloned=commands.map(cmd=>_objectSpread({},cmd));}return cloned.map(cmd=>{if(cmd!==null&&cmd!==void 0&&cmd.ExerciseCommand){const choiceArgument=applyMemoToArgument(cmd.ExerciseCommand.choiceArgument,memo);return _objectSpread(_objectSpread({},cmd),{},{ExerciseCommand:_objectSpread(_objectSpread({},cmd.ExerciseCommand),{},{choiceArgument})});}if(cmd!==null&&cmd!==void 0&&cmd.CreateCommand){const createArguments=applyMemoToArgument(cmd.CreateCommand.createArguments,memo);return _objectSpread(_objectSpread({},cmd),{},{CreateCommand:_objectSpread(_objectSpread({},cmd.CreateCommand),{},{createArguments})});}return cmd;});}function toTemplateIdString(templateId){if(typeof templateId===\"string\")return templateId;if(templateId&&typeof templateId===\"object\"&&typeof templateId.packageId===\"string\"&&typeof templateId.moduleName===\"string\"&&typeof templateId.entityName===\"string\"){return\"\".concat(templateId.packageId,\":\").concat(templateId.moduleName,\":\").concat(templateId.entityName);}return templateId;}function normalizeTemplateIds(commands){return commands.map(cmd=>{var _cmd$CreateCommand,_cmd$ExerciseCommand,_cmd$ExerciseByKeyCom;if(cmd!==null&&cmd!==void 0&&(_cmd$CreateCommand=cmd.CreateCommand)!==null&&_cmd$CreateCommand!==void 0&&_cmd$CreateCommand.templateId){const templateId=toTemplateIdString(cmd.CreateCommand.templateId);if(templateId!==cmd.CreateCommand.templateId){return _objectSpread(_objectSpread({},cmd),{},{CreateCommand:_objectSpread(_objectSpread({},cmd.CreateCommand),{},{templateId})});}}if(cmd!==null&&cmd!==void 0&&(_cmd$ExerciseCommand=cmd.ExerciseCommand)!==null&&_cmd$ExerciseCommand!==void 0&&_cmd$ExerciseCommand.templateId){const templateId=toTemplateIdString(cmd.ExerciseCommand.templateId);if(templateId!==cmd.ExerciseCommand.templateId){return _objectSpread(_objectSpread({},cmd),{},{ExerciseCommand:_objectSpread(_objectSpread({},cmd.ExerciseCommand),{},{templateId})});}}if(cmd!==null&&cmd!==void 0&&(_cmd$ExerciseByKeyCom=cmd.ExerciseByKeyCommand)!==null&&_cmd$ExerciseByKeyCom!==void 0&&_cmd$ExerciseByKeyCom.templateId){const templateId=toTemplateIdString(cmd.ExerciseByKeyCommand.templateId);if(templateId!==cmd.ExerciseByKeyCommand.templateId){return _objectSpread(_objectSpread({},cmd),{},{ExerciseByKeyCommand:_objectSpread(_objectSpread({},cmd.ExerciseByKeyCommand),{},{templateId})});}}return cmd;});}function buildEnvelope(input,commands){var _normalizePartyList;const commandId=input.deduplicationKey||\"loop-\".concat(Date.now(),\"-\").concat(Math.random().toString(36).slice(2,8));const workflowId=input.deduplicationKey?\"wf-\".concat(input.deduplicationKey):\"wf-\".concat(Date.now());const actAs=(_normalizePartyList=normalizePartyList(input.actAs))!==null&&_normalizePartyList!==void 0?_normalizePartyList:[];const readAs=normalizePartyList(input.readAs);const disclosedContracts=Array.isArray(input.disclosedContracts)?input.disclosedContracts:[];const envelope={commandId,workflowId,applicationId:DEFAULT_APP_ID,actAs,commands};if(disclosedContracts.length>0){envelope.disclosedContracts=disclosedContracts;}if(Array.isArray(input.packageIdSelectionPreference)&&input.packageIdSelectionPreference.length>0){envelope.packageIdSelectionPreference=input.packageIdSelectionPreference;}if(input.synchronizerId){envelope.synchronizerId=input.synchronizerId;}if(readAs&&readAs.length>0){envelope.readAs=readAs;}if(input.deduplicationKey){envelope.deduplicationKey=input.deduplicationKey;}return envelope;}function extractTrafficEstimation(resp){var _ref,_ref2,_ref3,_resp$trafficEstimati,_resp$traffic,_ref4,_traffic$estimationTi,_ref5,_ref6,_traffic$confirmation,_ref7,_ref8,_traffic$confirmation2,_ref9,_ref0,_traffic$totalTraffic;const traffic=(_ref=(_ref2=(_ref3=(_resp$trafficEstimati=resp===null||resp===void 0?void 0:resp.trafficEstimation)!==null&&_resp$trafficEstimati!==void 0?_resp$trafficEstimati:resp===null||resp===void 0?void 0:resp.traffic_cost_estimation)!==null&&_ref3!==void 0?_ref3:resp===null||resp===void 0?void 0:resp.trafficCostEstimation)!==null&&_ref2!==void 0?_ref2:resp===null||resp===void 0?void 0:(_resp$traffic=resp.traffic)===null||_resp$traffic===void 0?void 0:_resp$traffic.estimation)!==null&&_ref!==void 0?_ref:resp===null||resp===void 0?void 0:resp.traffic;if(!traffic)return undefined;return{estimationTimestamp:(_ref4=(_traffic$estimationTi=traffic.estimationTimestamp)!==null&&_traffic$estimationTi!==void 0?_traffic$estimationTi:traffic.timestamp)!==null&&_ref4!==void 0?_ref4:\"\",confirmationRequestTrafficCostEstimation:(_ref5=(_ref6=(_traffic$confirmation=traffic.confirmationRequestTrafficCostEstimation)!==null&&_traffic$confirmation!==void 0?_traffic$confirmation:traffic.confirmationRequestCost)!==null&&_ref6!==void 0?_ref6:traffic.requestCost)!==null&&_ref5!==void 0?_ref5:0,confirmationResponseTrafficCostEstimation:(_ref7=(_ref8=(_traffic$confirmation2=traffic.confirmationResponseTrafficCostEstimation)!==null&&_traffic$confirmation2!==void 0?_traffic$confirmation2:traffic.confirmationResponseCost)!==null&&_ref8!==void 0?_ref8:traffic.responseCost)!==null&&_ref7!==void 0?_ref7:0,totalTrafficCostEstimation:(_ref9=(_ref0=(_traffic$totalTraffic=traffic.totalTrafficCostEstimation)!==null&&_traffic$totalTraffic!==void 0?_traffic$totalTraffic:traffic.totalCost)!==null&&_ref0!==void 0?_ref0:traffic.total)!==null&&_ref9!==void 0?_ref9:0};}function extractFailures(resp){var _ref1,_ref10,_ref11,_resp$failures;return(_ref1=(_ref10=(_ref11=(_resp$failures=resp===null||resp===void 0?void 0:resp.failures)!==null&&_resp$failures!==void 0?_resp$failures:resp===null||resp===void 0?void 0:resp.failure)!==null&&_ref11!==void 0?_ref11:resp===null||resp===void 0?void 0:resp.errors)!==null&&_ref10!==void 0?_ref10:resp===null||resp===void 0?void 0:resp.error)!==null&&_ref1!==void 0?_ref1:null;}function extractStatus(resp){var _ref12,_ref13,_resp$txStatus,_resp$result;const status=(_ref12=(_ref13=(_resp$txStatus=resp===null||resp===void 0?void 0:resp.txStatus)!==null&&_resp$txStatus!==void 0?_resp$txStatus:resp===null||resp===void 0?void 0:resp.status)!==null&&_ref13!==void 0?_ref13:resp===null||resp===void 0?void 0:(_resp$result=resp.result)===null||_resp$result===void 0?void 0:_resp$result.status)!==null&&_ref12!==void 0?_ref12:null;if(typeof status===\"string\"){const upper=status.toUpperCase();if(upper.includes(\"FAIL\"))return\"FAILED\";if(upper.includes(\"SUCCESS\"))return\"SUCCEEDED\";}const failures=extractFailures(resp);if(failures)return\"FAILED\";return\"SUCCEEDED\";}function extractLedgerUpdateId(resp){var _ref14,_ref15,_ref16,_ref17,_ref18,_ref19,_ref20,_ref21,_ref22,_ref23,_ref24,_ref25,_ref26,_ref27,_ref28,_ref29,_ref30,_ref31,_ref32,_ref33,_resp$ledgerUpdateId,_resp$transaction,_resp$transaction2,_resp$transaction3,_resp$transaction4,_resp$update,_resp$update2,_resp$updateData,_resp$updateData2,_resp$update_data,_resp$update_data2,_resp$result2,_resp$result3,_resp$result4,_resp$result5;return(_ref14=(_ref15=(_ref16=(_ref17=(_ref18=(_ref19=(_ref20=(_ref21=(_ref22=(_ref23=(_ref24=(_ref25=(_ref26=(_ref27=(_ref28=(_ref29=(_ref30=(_ref31=(_ref32=(_ref33=(_resp$ledgerUpdateId=resp===null||resp===void 0?void 0:resp.ledgerUpdateId)!==null&&_resp$ledgerUpdateId!==void 0?_resp$ledgerUpdateId:resp===null||resp===void 0?void 0:resp.updateId)!==null&&_ref33!==void 0?_ref33:resp===null||resp===void 0?void 0:resp.update_id)!==null&&_ref32!==void 0?_ref32:resp===null||resp===void 0?void 0:resp.updateID)!==null&&_ref31!==void 0?_ref31:resp===null||resp===void 0?void 0:resp.transactionId)!==null&&_ref30!==void 0?_ref30:resp===null||resp===void 0?void 0:(_resp$transaction=resp.transaction)===null||_resp$transaction===void 0?void 0:_resp$transaction.updateId)!==null&&_ref29!==void 0?_ref29:resp===null||resp===void 0?void 0:(_resp$transaction2=resp.transaction)===null||_resp$transaction2===void 0?void 0:_resp$transaction2.update_id)!==null&&_ref28!==void 0?_ref28:resp===null||resp===void 0?void 0:(_resp$transaction3=resp.transaction)===null||_resp$transaction3===void 0?void 0:_resp$transaction3.transactionId)!==null&&_ref27!==void 0?_ref27:resp===null||resp===void 0?void 0:(_resp$transaction4=resp.transaction)===null||_resp$transaction4===void 0?void 0:_resp$transaction4.transaction_id)!==null&&_ref26!==void 0?_ref26:resp===null||resp===void 0?void 0:(_resp$update=resp.update)===null||_resp$update===void 0?void 0:_resp$update.updateId)!==null&&_ref25!==void 0?_ref25:resp===null||resp===void 0?void 0:(_resp$update2=resp.update)===null||_resp$update2===void 0?void 0:_resp$update2.update_id)!==null&&_ref24!==void 0?_ref24:resp===null||resp===void 0?void 0:(_resp$updateData=resp.updateData)===null||_resp$updateData===void 0?void 0:_resp$updateData.updateId)!==null&&_ref23!==void 0?_ref23:resp===null||resp===void 0?void 0:(_resp$updateData2=resp.updateData)===null||_resp$updateData2===void 0?void 0:_resp$updateData2.update_id)!==null&&_ref22!==void 0?_ref22:resp===null||resp===void 0?void 0:(_resp$update_data=resp.update_data)===null||_resp$update_data===void 0?void 0:_resp$update_data.update_id)!==null&&_ref21!==void 0?_ref21:resp===null||resp===void 0?void 0:(_resp$update_data2=resp.update_data)===null||_resp$update_data2===void 0?void 0:_resp$update_data2.updateId)!==null&&_ref20!==void 0?_ref20:resp===null||resp===void 0?void 0:(_resp$result2=resp.result)===null||_resp$result2===void 0?void 0:_resp$result2.updateId)!==null&&_ref19!==void 0?_ref19:resp===null||resp===void 0?void 0:(_resp$result3=resp.result)===null||_resp$result3===void 0?void 0:_resp$result3.update_id)!==null&&_ref18!==void 0?_ref18:resp===null||resp===void 0?void 0:(_resp$result4=resp.result)===null||_resp$result4===void 0?void 0:_resp$result4.transactionId)!==null&&_ref17!==void 0?_ref17:resp===null||resp===void 0?void 0:(_resp$result5=resp.result)===null||_resp$result5===void 0?void 0:_resp$result5.transaction_id)!==null&&_ref16!==void 0?_ref16:resp===null||resp===void 0?void 0:resp.commandId)!==null&&_ref15!==void 0?_ref15:resp===null||resp===void 0?void 0:resp.command_id)!==null&&_ref14!==void 0?_ref14:\"\";}function extractTransactionId(resp){var _ref34,_resp$transactionId,_resp$transaction5;return(_ref34=(_resp$transactionId=resp===null||resp===void 0?void 0:resp.transactionId)!==null&&_resp$transactionId!==void 0?_resp$transactionId:resp===null||resp===void 0?void 0:(_resp$transaction5=resp.transaction)===null||_resp$transaction5===void 0?void 0:_resp$transaction5.transactionId)!==null&&_ref34!==void 0?_ref34:undefined;}function extractMemoEcho(resp,memo){if(!resp)return memo;const queue=[resp];while(queue.length){const current=queue.shift();if(current&&typeof current===\"object\"){var _current$meta;if((_current$meta=current.meta)!==null&&_current$meta!==void 0&&_current$meta.values&&current.meta.values[MEMO_KEY]){return current.meta.values[MEMO_KEY];}for(const value of Object.values(current)){if(value&&typeof value===\"object\"){queue.push(value);}}}}return memo;}function mapError(err){if(!err){return{code:\"UNKNOWN\",message:\"Unknown error\"};}if(typeof err===\"string\"){return{code:\"ERROR\",message:err};}return{code:err.code||err.name||\"ERROR\",message:err.message||String(err),details:err};}export async function submitTx(input){const provider=getLoopProvider();if(!provider){return{ok:false,error:{code:\"NO_PROVIDER\",message:\"Loop provider is not connected\"}};}if(!input.commands||!Array.isArray(input.commands)||input.commands.length===0){return{ok:false,error:{code:\"VALIDATION\",message:\"commands is required\"}};}if(!input.actAs||Array.isArray(input.actAs)&&input.actAs.length===0){return{ok:false,error:{code:\"VALIDATION\",message:\"actAs is required\"}};}const mode=resolveMode(input.mode);const commandsWithMemo=applyMemoToCommands(input.commands,input.memo);const normalizedCommands=normalizeTemplateIds(commandsWithMemo);const envelope=buildEnvelope(input,normalizedCommands);const opts={timeoutMs:120000};if(input.estimateTraffic){opts.estimateTraffic=true;}const waitFn=provider.submitAndWaitForTransaction||provider.executeAndWait||provider.executeAndWaitForTransaction;const legacyFn=provider.submitTransaction;if(mode===\"WAIT\"&&typeof waitFn!==\"function\"&&!legacyEnabled()){return{ok:false,error:{code:\"NOT_SUPPORTED\",message:\"execute-and-wait is not supported by this Loop SDK\"}};}if(mode===\"LEGACY\"&&typeof legacyFn!==\"function\"){return{ok:false,error:{code:\"NOT_SUPPORTED\",message:\"submitTransaction is not supported by this Loop SDK\"}};}try{let response;if(mode===\"WAIT\"&&typeof waitFn===\"function\"){response=await waitFn.call(provider,envelope,opts);}else{const legacyOpts=_objectSpread({},opts);if(mode===\"WAIT\"){legacyOpts.mode=\"execute-and-wait\";}if(typeof legacyFn!==\"function\"){return{ok:false,error:{code:\"NOT_SUPPORTED\",message:\"submitTransaction is not available\"}};}response=await legacyFn.call(provider,envelope,legacyOpts);}const failures=extractFailures(response);const result={ledgerUpdateId:extractLedgerUpdateId(response),transactionId:extractTransactionId(response),txStatus:extractStatus(response),failures:failures||undefined,memoEcho:extractMemoEcho(response,input.memo),trafficEstimation:input.estimateTraffic?extractTrafficEstimation(response):undefined};return{ok:true,value:result};}catch(err){return{ok:false,error:mapError(err)};}}","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}