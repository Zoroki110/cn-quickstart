{"ast":null,"code":"import _objectSpread from\"/root/cn-quickstart/quickstart/frontend/node_modules/@babel/runtime/helpers/esm/objectSpread2.js\";import{useEffect,useState,useCallback}from\"react\";import{apiGet}from\"../api/client\";import{walletManager}from\"../wallet\";function decimalAddStrings(a,b){const sa=a!==null&&a!==void 0?a:\"0\";const sb=b!==null&&b!==void 0?b:\"0\";const[ia,fa=\"\"]=sa.split(\".\");const[ib,fb=\"\"]=sb.split(\".\");const fracLen=Math.max(fa.length,fb.length);const normFa=(fa+\"0\".repeat(fracLen)).slice(0,fracLen);const normFb=(fb+\"0\".repeat(fracLen)).slice(0,fracLen);const intA=BigInt(ia||\"0\");const intB=BigInt(ib||\"0\");const fracA=BigInt(normFa||\"0\");const fracB=BigInt(normFb||\"0\");const fracSum=fracA+fracB;const baseStr=\"1\"+\"0\".repeat(fracLen||0);const base=BigInt(baseStr);const carry=fracSum/base;const fracRes=fracSum%base;const intRes=intA+intB+carry;const fracStr=fracLen>0?fracRes.toString().padStart(fracLen,\"0\").replace(/0+$/,\"\"):\"\";return fracStr.length>0?\"\".concat(intRes.toString(),\".\").concat(fracStr):intRes.toString();}export function useHoldings(params){const{partyId,walletType}=params;const[holdings,setHoldings]=useState([]);const[loading,setLoading]=useState(false);const[error,setError]=useState(null);const[loopRetry,setLoopRetry]=useState(0);const[zoroRetry,setZoroRetry]=useState(0);const load=useCallback(async()=>{if(!partyId){setHoldings([]);setError(null);setLoading(false);return;}setLoading(true);setError(null);try{// Loop path: use connector wrapper methods to preserve provider binding and map balances.\nif(walletType===\"loop\"){const connector=walletManager.getLoopConnector();if(!connector){if(loopRetry<3){setLoopRetry(r=>r+1);setTimeout(()=>load(),500);}setLoading(false);return;}try{const loopHoldings=await connector.getHoldings();const normalized=Array.isArray(loopHoldings)?loopHoldings.map(normalizeLoopHolding).filter(Boolean):[];setHoldings(normalized);setLoading(false);return;}catch(err){console.warn(\"[Loop] getHoldings failed, fallback to backend\",err);}}if(walletType===\"zoro\"){var _getZoroConnector,_ref;const connector=(_getZoroConnector=(_ref=walletManager).getZoroConnector)===null||_getZoroConnector===void 0?void 0:_getZoroConnector.call(_ref);if(!connector){if(zoroRetry<3){setZoroRetry(r=>r+1);setTimeout(()=>load(),500);}setLoading(false);return;}try{const zoroHoldings=await connector.getHoldings();const normalized=Array.isArray(zoroHoldings)?zoroHoldings.map(normalizeZoroHolding).filter(Boolean):[];const aggregated=aggregateHoldings(normalized);setHoldings(aggregated);setLoading(false);return;}catch(err){console.warn(\"[Zoro] getHoldings failed, fallback to backend\",err);}}// Default path: backend API.\nconst data=await apiGet(\"/api/holdings/\".concat(encodeURIComponent(partyId)));const normalized=Array.isArray(data)?data.map(normalizeHolding).filter(Boolean):[];setHoldings(normalized);}catch(err){console.warn(\"Failed to load holdings for\",partyId,err);setHoldings([]);setError(err instanceof Error?err:new Error(\"Failed to load holdings\"));}finally{setLoading(false);}},[partyId,walletType,loopRetry,zoroRetry]);useEffect(()=>{load();},[load]);return{holdings,loading,error};}function normalizeHolding(raw){var _metadata,_ref2,_instrument$instrumen,_instrument$instrumen2,_ref3,_ref4,_ref5,_ref6,_ref7,_ref8,_ref9,_ref0,_ref1,_instrument$instrumen3,_instrument$instrumen4,_ref10,_ref11,_ref12,_name,_metadata2,_ref13,_ref14,_ref15,_amount,_ref16,_decimals;const instrument=raw===null||raw===void 0?void 0:raw.instrument;const metadata=(_metadata=raw===null||raw===void 0?void 0:raw.metadata)!==null&&_metadata!==void 0?_metadata:instrument===null||instrument===void 0?void 0:instrument.metadata;const rawInstrumentId=(_ref2=(_instrument$instrumen=instrument===null||instrument===void 0?void 0:(_instrument$instrumen2=instrument.instrumentId)===null||_instrument$instrumen2===void 0?void 0:_instrument$instrumen2.id)!==null&&_instrument$instrumen!==void 0?_instrument$instrumen:raw===null||raw===void 0?void 0:raw.instrumentId)!==null&&_ref2!==void 0?_ref2:null;const symbolCandidate=(_ref3=(_ref4=(_ref5=(_ref6=(_ref7=(_ref8=(_ref9=(_ref0=(_ref1=(_instrument$instrumen3=instrument===null||instrument===void 0?void 0:(_instrument$instrumen4=instrument.instrumentId)===null||_instrument$instrumen4===void 0?void 0:_instrument$instrumen4.id)!==null&&_instrument$instrumen3!==void 0?_instrument$instrumen3:instrument===null||instrument===void 0?void 0:instrument.symbol)!==null&&_ref1!==void 0?_ref1:instrument===null||instrument===void 0?void 0:instrument.assetCode)!==null&&_ref0!==void 0?_ref0:metadata===null||metadata===void 0?void 0:metadata.symbol)!==null&&_ref9!==void 0?_ref9:metadata===null||metadata===void 0?void 0:metadata.code)!==null&&_ref8!==void 0?_ref8:raw===null||raw===void 0?void 0:raw.symbol)!==null&&_ref7!==void 0?_ref7:raw===null||raw===void 0?void 0:raw.token)!==null&&_ref6!==void 0?_ref6:raw===null||raw===void 0?void 0:raw.assetCode)!==null&&_ref5!==void 0?_ref5:raw===null||raw===void 0?void 0:raw.currencyCode)!==null&&_ref4!==void 0?_ref4:rawInstrumentId)!==null&&_ref3!==void 0?_ref3:\"UNKNOWN\";let symbol=String(symbolCandidate!==null&&symbolCandidate!==void 0?symbolCandidate:\"UNKNOWN\").toUpperCase();let displayName=(_ref10=(_ref11=(_ref12=(_name=raw===null||raw===void 0?void 0:raw.name)!==null&&_name!==void 0?_name:raw===null||raw===void 0?void 0:(_metadata2=raw.metadata)===null||_metadata2===void 0?void 0:_metadata2.name)!==null&&_ref12!==void 0?_ref12:metadata===null||metadata===void 0?void 0:metadata.name)!==null&&_ref11!==void 0?_ref11:instrument===null||instrument===void 0?void 0:instrument.name)!==null&&_ref10!==void 0?_ref10:symbol===\"CC\"?\"Canton Coin\":undefined;if(rawInstrumentId===\"Amulet\"||symbol===\"AMULET\"){symbol=\"CC\";displayName=\"Canton Coin\";}const quantityCandidate=(_ref13=(_ref14=(_ref15=(_amount=raw===null||raw===void 0?void 0:raw.amount)!==null&&_amount!==void 0?_amount:raw===null||raw===void 0?void 0:raw.balance)!==null&&_ref15!==void 0?_ref15:raw===null||raw===void 0?void 0:raw.holdingAmount)!==null&&_ref14!==void 0?_ref14:raw===null||raw===void 0?void 0:raw.quantity)!==null&&_ref13!==void 0?_ref13:\"0\";const quantity=typeof quantityCandidate===\"string\"?quantityCandidate:String(quantityCandidate!==null&&quantityCandidate!==void 0?quantityCandidate:\"0\");const decimalsCandidate=(_ref16=(_decimals=raw===null||raw===void 0?void 0:raw.decimals)!==null&&_decimals!==void 0?_decimals:raw===null||raw===void 0?void 0:raw.precision)!==null&&_ref16!==void 0?_ref16:10;const decimals=typeof decimalsCandidate===\"number\"&&Number.isFinite(decimalsCandidate)?decimalsCandidate:parseInt(String(decimalsCandidate),10)||10;return{symbol,quantity,decimals,displayName};}function normalizeLoopHolding(raw){var _ref17,_symbol,_instrument_id,_instrumentId,_instrument_id2,_decimals2,_total_unlocked_coin,_total_locked_coin;if(!raw)return null;const symbolRaw=(_ref17=(_symbol=raw===null||raw===void 0?void 0:raw.symbol)!==null&&_symbol!==void 0?_symbol:raw===null||raw===void 0?void 0:(_instrument_id=raw.instrument_id)===null||_instrument_id===void 0?void 0:_instrument_id.id)!==null&&_ref17!==void 0?_ref17:raw===null||raw===void 0?void 0:(_instrumentId=raw.instrumentId)===null||_instrumentId===void 0?void 0:_instrumentId.id;let symbol=String(symbolRaw!==null&&symbolRaw!==void 0?symbolRaw:\"UNKNOWN\").toUpperCase();const instrumentId=(_instrument_id2=raw===null||raw===void 0?void 0:raw.instrument_id)!==null&&_instrument_id2!==void 0?_instrument_id2:raw===null||raw===void 0?void 0:raw.instrumentId;const decimalsCandidate=(_decimals2=raw===null||raw===void 0?void 0:raw.decimals)!==null&&_decimals2!==void 0?_decimals2:10;const decimals=typeof decimalsCandidate===\"number\"&&Number.isFinite(decimalsCandidate)?decimalsCandidate:parseInt(String(decimalsCandidate),10)||10;let displayName=raw===null||raw===void 0?void 0:raw.name;if((instrumentId===null||instrumentId===void 0?void 0:instrumentId.id)===\"Amulet\"||symbol===\"AMULET\"){symbol=\"CC\";displayName=\"Canton Coin\";}if(symbol===\"CBTC\"){var _displayName;displayName=(_displayName=displayName)!==null&&_displayName!==void 0?_displayName:\"CBTC\";}const totalUnlocked=String((_total_unlocked_coin=raw===null||raw===void 0?void 0:raw.total_unlocked_coin)!==null&&_total_unlocked_coin!==void 0?_total_unlocked_coin:\"0\");const totalLocked=String((_total_locked_coin=raw===null||raw===void 0?void 0:raw.total_locked_coin)!==null&&_total_locked_coin!==void 0?_total_locked_coin:\"0\");const quantity=decimalAddStrings(totalUnlocked,totalLocked);return{symbol,quantity,decimals,displayName};}function normalizeZoroHolding(raw){var _ref18,_ref19,_ref20,_ref21,_instrument$id,_instrument,_instrumentId2,_instrument_id3,_name2,_ref22,_ref23,_ref24,_amount2,_ref25,_decimals3;if(!raw)return null;const instrumentId=(_ref18=(_ref19=(_ref20=(_ref21=(_instrument$id=raw===null||raw===void 0?void 0:(_instrument=raw.instrument)===null||_instrument===void 0?void 0:_instrument.id)!==null&&_instrument$id!==void 0?_instrument$id:raw===null||raw===void 0?void 0:(_instrumentId2=raw.instrumentId)===null||_instrumentId2===void 0?void 0:_instrumentId2.id)!==null&&_ref21!==void 0?_ref21:raw===null||raw===void 0?void 0:(_instrument_id3=raw.instrument_id)===null||_instrument_id3===void 0?void 0:_instrument_id3.id)!==null&&_ref20!==void 0?_ref20:raw===null||raw===void 0?void 0:raw.instrumentId)!==null&&_ref19!==void 0?_ref19:raw===null||raw===void 0?void 0:raw.assetCode)!==null&&_ref18!==void 0?_ref18:raw===null||raw===void 0?void 0:raw.symbol;let symbol=String(instrumentId!==null&&instrumentId!==void 0?instrumentId:\"UNKNOWN\").toUpperCase();let displayName=(_name2=raw===null||raw===void 0?void 0:raw.name)!==null&&_name2!==void 0?_name2:raw===null||raw===void 0?void 0:raw.displayName;if(instrumentId===\"Amulet\"||symbol===\"AMULET\"){symbol=\"CC\";displayName=\"Canton Coin\";}const quantityCandidate=(_ref22=(_ref23=(_ref24=(_amount2=raw===null||raw===void 0?void 0:raw.amount)!==null&&_amount2!==void 0?_amount2:raw===null||raw===void 0?void 0:raw.quantity)!==null&&_ref24!==void 0?_ref24:raw===null||raw===void 0?void 0:raw.balance)!==null&&_ref23!==void 0?_ref23:raw===null||raw===void 0?void 0:raw.value)!==null&&_ref22!==void 0?_ref22:\"0\";const quantity=typeof quantityCandidate===\"string\"?quantityCandidate:String(quantityCandidate!==null&&quantityCandidate!==void 0?quantityCandidate:\"0\");const decimalsCandidate=(_ref25=(_decimals3=raw===null||raw===void 0?void 0:raw.decimals)!==null&&_decimals3!==void 0?_decimals3:raw===null||raw===void 0?void 0:raw.precision)!==null&&_ref25!==void 0?_ref25:10;const decimals=typeof decimalsCandidate===\"number\"&&Number.isFinite(decimalsCandidate)?decimalsCandidate:parseInt(String(decimalsCandidate),10)||10;return{symbol,quantity,decimals,displayName};}function aggregateHoldings(items){const map=new Map();for(const item of items){var _existing$decimals;const existing=map.get(item.symbol);if(!existing){map.set(item.symbol,_objectSpread({},item));continue;}const quantity=decimalAddStrings(existing.quantity,item.quantity);map.set(item.symbol,{symbol:item.symbol,quantity,decimals:(_existing$decimals=existing.decimals)!==null&&_existing$decimals!==void 0?_existing$decimals:item.decimals,displayName:existing.displayName||item.displayName});}return Array.from(map.values());}","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}