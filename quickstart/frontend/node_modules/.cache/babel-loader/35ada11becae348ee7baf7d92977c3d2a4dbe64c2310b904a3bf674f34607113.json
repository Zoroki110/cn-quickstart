{"ast":null,"code":"import{useCallback,useEffect,useState}from\"react\";import{walletManager}from\"../wallet\";const DEFAULT_DECIMALS=10;export function useLoopBalances(partyId,walletType){let options=arguments.length>2&&arguments[2]!==undefined?arguments[2]:{};const{refreshIntervalMs=15000,paused=false}=options;const[balances,setBalances]=useState({});const[loading,setLoading]=useState(false);const[isRefreshing,setIsRefreshing]=useState(false);const[error,setError]=useState(null);const hasBalances=Object.keys(balances).length>0;const fetchBalances=useCallback(async function(){let force=arguments.length>0&&arguments[0]!==undefined?arguments[0]:false;if(paused&&!force){return;}if(!partyId||walletType!==\"loop\"){setBalances({});setError(null);setLoading(false);setIsRefreshing(false);return;}const connector=walletManager.getOrCreateLoopConnector();const status=await connector.checkConnected();if(!status.connected){setError(null);setLoading(false);setIsRefreshing(false);return;}setIsRefreshing(true);if(!hasBalances){setLoading(true);}try{const rawHoldings=await connector.getHoldings();const rows=Array.isArray(rawHoldings)?rawHoldings:[];const map=rows.reduce((acc,row)=>{var _existing$decimals;const normalized=normalizeLoopHolding(row);if(!normalized){return acc;}const key=normalized.symbol.toUpperCase();const existing=acc[key];acc[key]={amount:existing?decimalAddStrings(existing.amount,normalized.quantity):normalized.quantity,decimals:(_existing$decimals=existing===null||existing===void 0?void 0:existing.decimals)!==null&&_existing$decimals!==void 0?_existing$decimals:normalized.decimals};return acc;},{});setBalances(map);setError(null);}catch(err){console.warn(\"Failed to load Loop balances\",err);setError(err instanceof Error?err:new Error(\"Failed to load Loop balances\"));}finally{setLoading(false);setIsRefreshing(false);}},[partyId,walletType,paused,hasBalances]);useEffect(()=>{if(paused){return;}fetchBalances();},[fetchBalances,paused]);useEffect(()=>{if(paused||!partyId||walletType!==\"loop\"||refreshIntervalMs<=0){return;}const interval=window.setInterval(()=>{fetchBalances();},refreshIntervalMs);return()=>{window.clearInterval(interval);};},[partyId,walletType,refreshIntervalMs,fetchBalances]);useEffect(()=>{if(typeof window===\"undefined\"){return;}if(paused){return;}const handleWalletConnected=()=>{fetchBalances();};window.addEventListener(\"clearportx:wallet:connected\",handleWalletConnected);return()=>{window.removeEventListener(\"clearportx:wallet:connected\",handleWalletConnected);};},[fetchBalances]);return{balances,loading,isRefreshing,error,reload:()=>fetchBalances(true)};}function normalizeLoopHolding(raw){var _ref,_ref2,_ref3,_symbol,_instrument_id,_instrumentId,_instrument_id2,_decimals,_total_unlocked_coin,_total_locked_coin,_ref4,_ref5,_ref6,_amount;if(!raw)return null;const symbolRaw=(_ref=(_ref2=(_ref3=(_symbol=raw===null||raw===void 0?void 0:raw.symbol)!==null&&_symbol!==void 0?_symbol:raw===null||raw===void 0?void 0:(_instrument_id=raw.instrument_id)===null||_instrument_id===void 0?void 0:_instrument_id.id)!==null&&_ref3!==void 0?_ref3:raw===null||raw===void 0?void 0:(_instrumentId=raw.instrumentId)===null||_instrumentId===void 0?void 0:_instrumentId.id)!==null&&_ref2!==void 0?_ref2:raw===null||raw===void 0?void 0:raw.instrument_id)!==null&&_ref!==void 0?_ref:raw===null||raw===void 0?void 0:raw.instrumentId;let symbol=String(symbolRaw!==null&&symbolRaw!==void 0?symbolRaw:\"UNKNOWN\").toUpperCase();const instrumentId=(_instrument_id2=raw===null||raw===void 0?void 0:raw.instrument_id)!==null&&_instrument_id2!==void 0?_instrument_id2:raw===null||raw===void 0?void 0:raw.instrumentId;if((instrumentId===null||instrumentId===void 0?void 0:instrumentId.id)===\"Amulet\"||symbol===\"AMULET\"){symbol=\"CC\";}const decimalsCandidate=(_decimals=raw===null||raw===void 0?void 0:raw.decimals)!==null&&_decimals!==void 0?_decimals:DEFAULT_DECIMALS;const decimals=typeof decimalsCandidate===\"number\"&&Number.isFinite(decimalsCandidate)?decimalsCandidate:parseInt(String(decimalsCandidate),10)||DEFAULT_DECIMALS;const totalUnlocked=String((_total_unlocked_coin=raw===null||raw===void 0?void 0:raw.total_unlocked_coin)!==null&&_total_unlocked_coin!==void 0?_total_unlocked_coin:\"\");const totalLocked=String((_total_locked_coin=raw===null||raw===void 0?void 0:raw.total_locked_coin)!==null&&_total_locked_coin!==void 0?_total_locked_coin:\"\");if(totalUnlocked||totalLocked){const quantity=decimalAddStrings(totalUnlocked||\"0\",totalLocked||\"0\");return{symbol,quantity,decimals};}const quantityCandidate=(_ref4=(_ref5=(_ref6=(_amount=raw===null||raw===void 0?void 0:raw.amount)!==null&&_amount!==void 0?_amount:raw===null||raw===void 0?void 0:raw.balance)!==null&&_ref6!==void 0?_ref6:raw===null||raw===void 0?void 0:raw.holdingAmount)!==null&&_ref5!==void 0?_ref5:raw===null||raw===void 0?void 0:raw.quantity)!==null&&_ref4!==void 0?_ref4:\"0\";const quantity=typeof quantityCandidate===\"string\"?quantityCandidate:String(quantityCandidate!==null&&quantityCandidate!==void 0?quantityCandidate:\"0\");return{symbol,quantity,decimals};}function decimalAddStrings(a,b){const sa=a!==null&&a!==void 0?a:\"0\";const sb=b!==null&&b!==void 0?b:\"0\";const[ia,fa=\"\"]=sa.split(\".\");const[ib,fb=\"\"]=sb.split(\".\");const fracLen=Math.max(fa.length,fb.length);const normFa=(fa+\"0\".repeat(fracLen)).slice(0,fracLen);const normFb=(fb+\"0\".repeat(fracLen)).slice(0,fracLen);const intA=BigInt(ia||\"0\");const intB=BigInt(ib||\"0\");const fracA=BigInt(normFa||\"0\");const fracB=BigInt(normFb||\"0\");const fracSum=fracA+fracB;const baseStr=\"1\"+\"0\".repeat(fracLen||0);const base=BigInt(baseStr);const carry=fracSum/base;const fracRes=fracSum%base;const intRes=intA+intB+carry;const fracStr=fracLen>0?fracRes.toString().padStart(fracLen,\"0\").replace(/0+$/,\"\"):\"\";return fracStr.length>0?\"\".concat(intRes.toString(),\".\").concat(fracStr):intRes.toString();}","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}