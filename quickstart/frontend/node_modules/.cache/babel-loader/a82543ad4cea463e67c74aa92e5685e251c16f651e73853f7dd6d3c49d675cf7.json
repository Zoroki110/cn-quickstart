{"ast":null,"code":"import React,{useState,useEffect,useRef,useMemo}from'react';import{Link,useLocation}from'react-router-dom';import{useAppStore}from'../stores';import{useWalletAuth}from'../wallet';import{ENABLE_MANUAL_WALLET}from'../wallet/walletConfig';import{useLoopBalances,useUtxoBalances}from'../hooks';import toast from'react-hot-toast';import{jsx as _jsx,jsxs as _jsxs,Fragment as _Fragment}from\"react/jsx-runtime\";const Header=()=>{const location=useLocation();const{theme,setTheme}=useAppStore();const{partyId,walletType,loading:walletLoading,error:walletError,authenticateWithDev,authenticateWithLoop,authenticateWithZoro,disconnect}=useWalletAuth();const partyForBackend=walletType==='loop'?null:partyId||null;const{balances:loopBalances,loading:loopLoading,isRefreshing:loopRefreshing}=useLoopBalances(partyId||null,walletType,{refreshIntervalMs:15000});const{balances:utxoBalances,loading:utxoLoading,isRefreshing:utxoRefreshing}=useUtxoBalances(partyForBackend,{ownerOnly:true,refreshIntervalMs:15000});const balancesLoading=walletType==='loop'?loopLoading:utxoLoading;const balancesRefreshing=walletType==='loop'?loopRefreshing:utxoRefreshing;const balanceEntries=useMemo(()=>{if(walletType==='loop'){return Object.entries(loopBalances).map(_ref=>{let[symbol,entry]=_ref;return{symbol:symbol.toUpperCase(),amount:entry.amount,decimals:entry.decimals};}).sort((a,b)=>Number(b.amount)-Number(a.amount));}const acc=new Map();Object.values(utxoBalances).forEach(entry=>{var _existing$decimals;const symbol=instrumentIdToSymbol(entry.instrumentId);const existing=acc.get(symbol);if(!existing){acc.set(symbol,{symbol,amount:entry.amount,decimals:entry.decimals});return;}acc.set(symbol,{symbol,amount:decimalAddStrings(existing.amount,entry.amount),decimals:(_existing$decimals=existing.decimals)!==null&&_existing$decimals!==void 0?_existing$decimals:entry.decimals});});return Array.from(acc.values()).sort((a,b)=>Number(b.amount)-Number(a.amount));},[walletType,loopBalances,utxoBalances]);const[menuOpen,setMenuOpen]=useState(false);const dropdownRef=useRef(null);useEffect(()=>{const handler=event=>{if(dropdownRef.current&&!dropdownRef.current.contains(event.target)){setMenuOpen(false);}};if(menuOpen){document.addEventListener('mousedown',handler);}return()=>document.removeEventListener('mousedown',handler);},[menuOpen]);const navigation=[{name:'Swap',href:'/swap'},{name:'Pools',href:'/pools'},{name:'Liquidity',href:'/liquidity'},{name:'History',href:'/history'}];const toggleTheme=()=>{setTheme(theme==='light'?'dark':'light');};const baseWalletOptions=[{key:'loop',label:'Loop Wallet',description:'Se connecter avec le SDK Loop officiel.',iconSrc:'/loop.svg',iconAlt:'Loop Wallet logo',action:authenticateWithLoop},{key:'zoro',label:'Zoro Wallet',description:'Utiliser la future extension Zoro.',iconSrc:'/zoro.svg',iconAlt:'Zoro Wallet logo',action:authenticateWithZoro}];const walletOptions=ENABLE_MANUAL_WALLET?[{key:'party',label:'Party ID (manuel)',description:'Saisir un party Canton et signer le challenge via Dev Wallet.',iconSrc:'/clearportx-logo.svg',iconAlt:'ClearportX logo',action:authenticateWithDev},...baseWalletOptions]:baseWalletOptions;// Keep synchronous so wallet connect runs in the click stack (needed for Loop popup).\nconst handleConnect=action=>{try{const res=action();if(res&&typeof res.catch===\"function\"){res.catch(err=>{toast.error(err instanceof Error?err.message:\"Wallet connection failed\");console.error(\"Wallet connection failed\",err);});}setMenuOpen(false);}catch(err){toast.error(err instanceof Error?err.message:\"Wallet connection failed\");console.error(\"Wallet connection failed\",err);}};const connected=Boolean(partyId);return/*#__PURE__*/_jsx(\"header\",{className:\"sticky top-0 z-50 glass-strong border-b border-gray-200/20 dark:border-gray-700/20\",children:/*#__PURE__*/_jsx(\"div\",{className:\"container-app\",children:/*#__PURE__*/_jsxs(\"div\",{className:\"flex items-center justify-between h-16\",children:[/*#__PURE__*/_jsxs(Link,{to:\"/\",className:\"flex items-center space-x-3\",children:[/*#__PURE__*/_jsx(\"div\",{className:\"h-10 w-10 rounded-lg bg-white dark:bg-white p-1 flex items-center justify-center\",children:/*#__PURE__*/_jsx(\"img\",{src:\"/clearportx-logo.svg\",alt:\"ClearportX Logo\",className:\"h-full w-full\"})}),/*#__PURE__*/_jsxs(\"div\",{className:\"hidden sm:block\",children:[/*#__PURE__*/_jsx(\"h1\",{className:\"text-xl font-bold text-gradient-clearportx\",children:\"ClearportX\"}),/*#__PURE__*/_jsx(\"p\",{className:\"text-xs text-gray-500 dark:text-gray-400\",children:\"Institutional Digital Asset Trading\"})]})]}),/*#__PURE__*/_jsx(\"nav\",{className:\"hidden md:flex items-center space-x-1\",children:navigation.map(item=>{const isActive=location.pathname===item.href||location.pathname==='/'&&item.href==='/swap';return/*#__PURE__*/_jsx(Link,{to:item.href,className:\"px-4 py-2 rounded-lg font-medium transition-all duration-200 \".concat(isActive?'text-accent-600 dark:text-accent-500 bg-accent-50 dark:bg-accent-900/20':'text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-100 hover:bg-gray-100 dark:hover:bg-dark-800'),children:item.name},item.name);})}),/*#__PURE__*/_jsxs(\"div\",{className:\"flex items-center space-x-3\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"relative\",ref:dropdownRef,children:[/*#__PURE__*/_jsxs(\"button\",{type:\"button\",onClick:()=>setMenuOpen(prev=>!prev),disabled:walletLoading,className:\"flex items-center gap-3 rounded-xl border px-4 py-2 text-left shadow-sm transition duration-200 min-w-[180px] \".concat(connected?'border-emerald-200/60 bg-emerald-50 dark:border-emerald-900/40 dark:bg-emerald-900/20 text-emerald-900 dark:text-emerald-200':'border-primary-200/60 bg-white/80 dark:border-dark-700 dark:bg-dark-800 text-gray-800 dark:text-gray-100',\" \").concat(walletLoading?'opacity-70 cursor-not-allowed':'hover:shadow-lg'),children:[/*#__PURE__*/_jsxs(\"div\",{className:\"flex-1\",children:[/*#__PURE__*/_jsx(\"p\",{className:\"text-[11px] uppercase tracking-[0.2em] text-gray-400 dark:text-gray-500\",children:\"Wallet\"}),/*#__PURE__*/_jsx(\"p\",{className:\"text-sm font-semibold\",children:connected?formatPartyId(partyId):'Connect Wallet'}),connected&&/*#__PURE__*/_jsx(\"p\",{className:\"text-xs text-gray-500 dark:text-gray-400\",children:walletType?walletType.toUpperCase():'Unknown'})]}),/*#__PURE__*/_jsx(\"svg\",{className:\"w-4 h-4 transition-transform \".concat(menuOpen?'rotate-180':''),fill:\"none\",stroke:\"currentColor\",viewBox:\"0 0 24 24\",children:/*#__PURE__*/_jsx(\"path\",{strokeLinecap:\"round\",strokeLinejoin:\"round\",strokeWidth:2,d:\"M19 9l-7 7-7-7\"})})]}),menuOpen&&/*#__PURE__*/_jsx(\"div\",{className:\"absolute right-0 mt-3 w-80 rounded-2xl border border-gray-200/80 dark:border-gray-700 bg-white dark:bg-dark-900 shadow-2xl backdrop-blur p-4 space-y-3\",children:connected?/*#__PURE__*/_jsxs(_Fragment,{children:[/*#__PURE__*/_jsxs(\"div\",{className:\"rounded-xl border border-emerald-100 dark:border-emerald-900/40 bg-emerald-50/60 dark:bg-emerald-900/10 px-4 py-3\",children:[/*#__PURE__*/_jsx(\"p\",{className:\"text-xs uppercase tracking-wide text-emerald-600 dark:text-emerald-300\",children:\"Connect\\xE9\"}),/*#__PURE__*/_jsx(\"p\",{className:\"font-semibold text-gray-900 dark:text-white break-all\",children:partyId}),/*#__PURE__*/_jsxs(\"p\",{className:\"text-xs text-gray-500 dark:text-gray-400 mt-1\",children:[\"Wallet: \",walletType!==null&&walletType!==void 0?walletType:'unknown']})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"mt-3 text-sm text-gray-700 dark:text-gray-200\",children:[/*#__PURE__*/_jsx(\"div\",{className:\"font-semibold mb-1\",children:\"Balances\"}),balancesLoading&&/*#__PURE__*/_jsx(\"div\",{className:\"text-xs opacity-70\",children:\"Loading on-ledger balances\\u2026\"}),!balancesLoading&&balancesRefreshing&&/*#__PURE__*/_jsx(\"div\",{className:\"text-xs opacity-70\",children:\"Updating\\u2026\"}),!balancesLoading&&!balancesRefreshing&&balanceEntries.length===0&&/*#__PURE__*/_jsx(\"div\",{className:\"text-xs opacity-70\",children:\"No holdings visible\"}),!balancesLoading&&balanceEntries.length>0&&balanceEntries.slice(0,5).map(h=>/*#__PURE__*/_jsxs(\"div\",{className:\"flex justify-between\",children:[/*#__PURE__*/_jsx(\"span\",{children:h.symbol}),/*#__PURE__*/_jsx(\"span\",{children:formatHoldingAmount(h.symbol,h.amount,h.decimals)})]},h.symbol)),!balancesLoading&&balanceEntries.length>5&&/*#__PURE__*/_jsxs(\"div\",{className:\"text-xs opacity-70 mt-1\",children:[\"+ \",balanceEntries.length-5,\" more\"]})]}),/*#__PURE__*/_jsx(\"button\",{type:\"button\",onClick:()=>{disconnect();setMenuOpen(false);},className:\"w-full rounded-xl border border-gray-300 dark:border-gray-700 px-4 py-2 text-sm font-semibold text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-dark-800 transition\",children:\"Disconnect\"})]}):/*#__PURE__*/_jsxs(_Fragment,{children:[walletOptions.map(option=>/*#__PURE__*/_jsx(\"button\",{type:\"button\",disabled:walletLoading,onClick:()=>handleConnect(option.action),className:\"w-full text-left rounded-2xl border border-gray-200 dark:border-gray-700 px-4 py-3 transition bg-white/90 dark:bg-dark-800/80 hover:-translate-y-0.5 hover:shadow-lg disabled:opacity-60\",children:/*#__PURE__*/_jsxs(\"div\",{className:\"flex items-center justify-between gap-4\",children:[/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsx(\"p\",{className:\"text-sm font-semibold text-gray-900 dark:text-white\",children:option.label}),/*#__PURE__*/_jsx(\"p\",{className:\"text-xs text-gray-500 dark:text-gray-400 mt-1\",children:option.description})]}),/*#__PURE__*/_jsx(\"div\",{className:\"flex-shrink-0 w-12 h-12 rounded-full border border-gray-200 dark:border-gray-700 bg-white dark:bg-dark-800 shadow-sm flex items-center justify-center overflow-hidden\",children:/*#__PURE__*/_jsx(\"img\",{src:option.iconSrc,alt:option.iconAlt,className:\"w-8 h-8 object-contain\",loading:\"lazy\"})})]})},option.key)),walletError&&/*#__PURE__*/_jsx(\"p\",{className:\"text-sm text-rose-500 dark:text-rose-400\",children:walletError}),walletLoading&&/*#__PURE__*/_jsx(\"p\",{className:\"text-xs text-gray-500 dark:text-gray-400\",children:\"Connexion en cours\\u2026\"})]})})]}),/*#__PURE__*/_jsx(\"button\",{onClick:toggleTheme,className:\"p-2 rounded-lg bg-gray-100 dark:bg-dark-800 text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-100 transition-colors duration-200\",title:theme==='light'?'Switch to dark mode':'Switch to light mode',children:theme==='light'?/*#__PURE__*/_jsx(\"svg\",{className:\"w-5 h-5\",fill:\"none\",stroke:\"currentColor\",viewBox:\"0 0 24 24\",children:/*#__PURE__*/_jsx(\"path\",{strokeLinecap:\"round\",strokeLinejoin:\"round\",strokeWidth:2,d:\"M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z\"})}):/*#__PURE__*/_jsx(\"svg\",{className:\"w-5 h-5\",fill:\"none\",stroke:\"currentColor\",viewBox:\"0 0 24 24\",children:/*#__PURE__*/_jsx(\"path\",{strokeLinecap:\"round\",strokeLinejoin:\"round\",strokeWidth:2,d:\"M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z\"})})})]})]})})});};// Sanity: formatHoldingAmount(\"CC\", \"188800\", 10) => \"188,800\"\n// Sanity: formatHoldingAmount(\"CBTC\", \"1.1\", 8) => \"1.1000\"\nfunction formatHoldingAmount(symbol,quantity,decimals){const num=Number(quantity);const isCc=(symbol===null||symbol===void 0?void 0:symbol.toUpperCase())==='CC';const valid=Number.isFinite(num);const formatter=new Intl.NumberFormat('en-US',{useGrouping:true,minimumFractionDigits:isCc?0:0,maximumFractionDigits:isCc?0:4});const formatted=formatter.format(valid?num:0);// For non-CC, drop trailing zeros after the decimal point.\nif(!isCc&&formatted.includes('.')){return formatted.replace(/\\.0+$/,'').replace(/(\\.\\d*?)0+$/,'$1');}return formatted;}function instrumentIdToSymbol(instrumentId){const raw=instrumentId||'';const upper=raw.toUpperCase();if(upper==='AMULET'){return'CC';}return upper;}function decimalAddStrings(a,b){const sa=a!==null&&a!==void 0?a:'0';const sb=b!==null&&b!==void 0?b:'0';const[ia,fa='']=sa.split('.');const[ib,fb='']=sb.split('.');const fracLen=Math.max(fa.length,fb.length);const normFa=(fa+'0'.repeat(fracLen)).slice(0,fracLen);const normFb=(fb+'0'.repeat(fracLen)).slice(0,fracLen);const intA=BigInt(ia||'0');const intB=BigInt(ib||'0');const fracA=BigInt(normFa||'0');const fracB=BigInt(normFb||'0');const fracSum=fracA+fracB;const baseStr='1'+'0'.repeat(fracLen||0);const base=BigInt(baseStr);const carry=fracSum/base;const fracRes=fracSum%base;const intRes=intA+intB+carry;const fracStr=fracLen>0?fracRes.toString().padStart(fracLen,'0').replace(/0+$/,''):'';return fracStr.length>0?\"\".concat(intRes.toString(),\".\").concat(fracStr):intRes.toString();}function formatPartyId(party){if(!party)return'Not connected';if(party.length<=22){return party;}return\"\".concat(party.slice(0,10),\"\\u2026\").concat(party.slice(-6));}export default Header;","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}